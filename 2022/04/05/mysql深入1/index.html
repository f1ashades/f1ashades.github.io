<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/source/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="事务：四大特性、隔离级别 常见引擎：InnoDB、Myisam、Memory，各自特性及比较 索引：结构、分类、语法、使用规则 sql优化：insert、order by、group by、limit、count、update 视图&#x2F;存储过程&#x2F;触发器：语法、使用 锁：全局锁、表级锁（读写锁、元数据锁、意向锁）、行级锁（读写锁、临键锁、间隙锁） InnoDB引擎：物理结构、逻辑结">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql深入">
<meta property="og:url" content="http://example.com/2022/04/05/mysql%E6%B7%B1%E5%85%A51/index.html">
<meta property="og:site_name" content="f1ashades&#39; blogs">
<meta property="og:description" content="事务：四大特性、隔离级别 常见引擎：InnoDB、Myisam、Memory，各自特性及比较 索引：结构、分类、语法、使用规则 sql优化：insert、order by、group by、limit、count、update 视图&#x2F;存储过程&#x2F;触发器：语法、使用 锁：全局锁、表级锁（读写锁、元数据锁、意向锁）、行级锁（读写锁、临键锁、间隙锁） InnoDB引擎：物理结构、逻辑结">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2022/06/04/6zLJYsUrRBe2ZNT.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/04/YBGfNA1QK29bsaF.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/04/FnZ4XWVfNEJ5k9h.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/04/UFR5N6rMGEKVnIs.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/04/9cftzj5epWYIF6V.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/04/1kgTeC5UNWFiEIf.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/04/Q21ABD6jfdZPi8p.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/04/aKtQdNDGo6iLmEC.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/04/z2J1p8j9EChBwcN.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/30/ocWZvNhuSs1VBgt.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/04/KwRVxtr2qhoFd7g.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/04/WGJnCjK37u2v68o.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/04/brk8NdOZXlhq23t.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/30/zqmAFYeTyiXBrNl.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/30/AnONs5KXudJpZgv.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/30/AgFNWb4lrUYofGe.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/30/VRtgf75F6iyTZXM.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/30/oej2vmnNVUDzhWZ.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/30/IyqERfjPizUQOSs.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/30/6QNDVjHxdI5Fatu.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/30/ez7OVMCQshElxrT.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/30/LHd9CkzsG2rFv5p.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/30/cCjQklvUs84A76o.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/30/7MSNr4i3qFDPYb2.png">
<meta property="og:image" content="https://s2.loli.net/2022/04/30/75qcEWAOeDoXujJ.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/04/TgKzdrDO5u6Mxf2.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/03/ivgQnFRIlw8AuPS.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/03/8NQSBUeDgXZ5Apy.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/03/RYzTaZNEGrg5xuk.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/04/PxhtBiqX7AenEkU.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/06/VwHtZGLrs3XCBof.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/04/jKNSIomCEZrgUYO.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/04/PF2Ilnyv3WgJ158.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/04/w3E84SoP5DQrZfz.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/04/Vt5c6AhszexKqJ4.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/04/qWYeCaVbirOBp5U.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/04/6NOkcM4nKSljq2P.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/04/O56V1xY4XIUQKdC.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/04/4TOz2eSnJlQgwMG.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/PRMQ3GcIDke2JT8.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/FkjyDKNR7I3vOJp.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/OWcUtonTPCm1AIz.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/sdyktMcIi34x7Yf.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/om9e35AVERQkFtp.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/nvBiLafzYgQoTdE.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/sGodEcNFX4xguPp.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/6iQB9kvRUHuPTaF.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/OfSv69jIyRxr2ZU.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/1YSkTZX36dUajbK.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/6sTWjenSC1rkZJK.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/Q7jpROgLsWVGa8F.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/oVfsBG8Y5zRk9g2.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/Kqopg7ycnHTEiJA.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/5tnMHfhJiLPN8zA.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/05/VZqa8Y4G7PQkyn1.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/06/PKirfo5e8sMUayt.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/06/U28D1M73bECdFNB.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/06/FPUskB4agijIlmc.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/06/NIjZkwAqCT8ag17.png">
<meta property="og:image" content="https://s2.loli.net/2022/06/06/q3dHPWGOjCmbiuV.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/j9Lu6eoVDGWrx1Y.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/PhS8i3A7YzEHNxm.png">
<meta property="og:image" content="d:/Typora/TyporaPictureBed/image-20220810140251418.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/xofWdeGj46PXapn.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/Auf65IJFRTaBkV2.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/WNq4xmK3uFQkyEJ.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/1jurzLWNCq38GgR.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/elfca7NMZozb5Bs.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/K8Pkat2cEFLAWrj.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/UORIs8H4YrPA6V5.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/STAePBOwDfnj7cJ.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/3Y2QDaPhfWiwut7.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/sZq8wyVMIe5RbNj.png">
<meta property="og:image" content="https://s2.loli.net/2022/08/10/sdjK29g4r8hlkTD.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/Zz9ab24JAr8dVH6.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/L71U5qov6S9tWiG.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/jxo8dW4E9SOysR5.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/85OGm1gbYc6hKCd.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/d4oGYh6kLnMiXzW.png">
<meta property="og:image" content="https://s2.loli.net/2022/08/10/YFgkevKsO7opDPd.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/pebuDKW48JadAIx.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/K2E1FBPGgZdwhQ3.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/O1EnUrXhtJMRKDP.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/dPaH7NSteDTi8hI.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/85TpM4tfOrSyZAE.png">
<meta property="og:image" content="d:/Typora/TyporaPictureBed/image-20220509170102112.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/EeXWmpy6u9o4qMV.png">
<meta property="og:image" content="https://s2.loli.net/2022/05/09/6bDL1dOAgfG9ev4.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/FxHmCiQjO5UPM6p.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/AsjEXfJRNBtFC65.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/2jIA6xJwK7vhDVn.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/9qgis8NL1R3BWOy.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/jP9LnsSoGIafyVp.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/nAjQq5YU2EdLrsN.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/ot1lLZE6FBVHGjW.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/GIWvJRsie52UDM9.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/C4jcu8WKbH7AXR3.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/uqbBxYOF5RtE7IA.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/qRbsd7AVSBz65Xh.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/GHyp5B2nRiAkTO8.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/iCzwRgxaBIbs9Fv.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/4rDN2u5I6XomSiV.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/NRoBWic3mLefYUb.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/9EUjaVmhCKOqcQ2.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/FNEjxPsyDI1ohiL.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/58kGVyh4Km3MOJW.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/T2auHMiWUhk1Y9R.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/7SM1yJNnfo4FU8i.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/VESnA2J4sXuYFN9.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/3GFQHgfcTEai5JL.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/mYZtMlBjqinsGku.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/wVWJLjO3Q6monyc.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/nveVBk9r3ZhOPYi.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/qzRZPhK6FY98UQj.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/GSUOiK8gIDcqQtR.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/qze5NpQyXkYcrMD.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/r37Vsjx9d6KPnu2.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/6bXVimYxZtgrIy3.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/uHK5sjb3TvnVOcx.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/JGpaV8qb3cstwNH.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/QTFty7m3qkZAGlW.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/f6T9mzyKDMjhOUG.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/k5xTrNLZu4wpyFU.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/gLPz2n7CJowHKZu.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/5MYLQu9rziwUpGV.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/TnbXmgQaCJE5WZM.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/VFC5Gc2svUKIHZa.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/2X4bD7YqUxryLoC.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/PWoNntGs6fSqz9p.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/WDLnzAelRHisuyJ.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/Clu2wF1mYDtg8Sa.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/OsBgUe1t9jzxaZ2.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/SPR8Fp6azq7ycIA.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/vxwizPVYB17RUn8.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/e43nVwP6ubEYl91.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/NdGWvQgFCOszXTw.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/rsoAqwlH4nKyaGz.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/jJkgz4xZtdiNeIO.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/RTQEzvpBJ7GPYgd.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/OHIpoKh7FZwnGgJ.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/u7jCsrwp5l1kB3c.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/xUoTrb8ftpCuwjl.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/1nYJquso7RbgDOc.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/wk5cJli4SPvoOxB.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/6vkJMymdecAT4Pz.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/4DRJ1vZubwpznEQ.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/R6ZouLfi2QdGJn8.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/AEdIe5PuLioskc3.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/fb9IJ74NGWVgcE6.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/JerfzYnSMUoLdt9.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/jsFT7ZdQAEIao4D.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/1dPCQFeINMu8wrp.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/fzG1PNBgWQKO4cZ.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/HNPqpw5ZlACn3Y7.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/noOqhs3VC8idgWF.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/trzvu2KpgwRV91q.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/8PiBRArmn6DJXHy.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/aQ3duPGOAqNBKYD.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/QyqFYMouOxelrnZ.png">
<meta property="og:image" content="https://s2.loli.net/2022/07/21/1ErpR5x4LhSmtBC.png">
<meta property="article:published_time" content="2022-04-05T07:29:48.000Z">
<meta property="article:modified_time" content="2022-08-10T08:19:42.604Z">
<meta property="article:author" content="f1ashades">
<meta property="article:tag" content="mysql">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2022/06/04/6zLJYsUrRBe2ZNT.png">

<link rel="canonical" href="http://example.com/2022/04/05/mysql%E6%B7%B1%E5%85%A51/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>mysql深入 | f1ashades' blogs</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">f1ashades' blogs</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/04/05/mysql%E6%B7%B1%E5%85%A51/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/mine.jpg">
      <meta itemprop="name" content="f1ashades">
      <meta itemprop="description" content="once again I am a child">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="f1ashades' blogs">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          mysql深入
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2022-04-05 15:29:48" itemprop="dateCreated datePublished" datetime="2022-04-05T15:29:48+08:00">2022-04-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-08-10 16:19:42" itemprop="dateModified" datetime="2022-08-10T16:19:42+08:00">2022-08-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mysql/" itemprop="url" rel="index"><span itemprop="name">mysql</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>50k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>45 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>事务：四大特性、隔离级别</p>
<p>常见引擎：InnoDB、Myisam、Memory，各自特性及比较</p>
<p>索引：结构、分类、语法、使用规则</p>
<p>sql优化：insert、order by、group by、limit、count、update</p>
<p>视图&#x2F;存储过程&#x2F;触发器：语法、使用</p>
<p>锁：全局锁、表级锁（读写锁、元数据锁、意向锁）、行级锁（读写锁、临键锁、间隙锁）</p>
<p>InnoDB引擎：物理结构、逻辑结构、事务原理（redo log、undo log、MVCC）</p>
<p>高可用：日志（错误、bin log、查询、慢查询）、主从复制（binlog）、分库分表、读写分离</p>
<span id="more"></span>

<h1 id="一、事务"><a href="#一、事务" class="headerlink" title="一、事务"></a>一、事务</h1><p>事务是一组操作的集合，事务会把所有操作作为一个整体一起向系统提交或撤销操作请求，即这些操作要么同时成功，要么同时失败。</p>
<p>基本操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">-- 1. 查询张三账户余额</span><br><span class="line">select * from account where name = &#x27;张三&#x27;;</span><br><span class="line">-- 2. 将张三账户余额-1000</span><br><span class="line">update account set money = money - 1000 where name = &#x27;张三&#x27;;</span><br><span class="line">-- 此语句出错后张三钱减少但是李四钱没有增加</span><br><span class="line">模拟sql语句错误</span><br><span class="line">-- 3. 将李四账户余额+1000</span><br><span class="line">update account set money = money + 1000 where name = &#x27;李四&#x27;;</span><br><span class="line"></span><br><span class="line">-- 查看事务提交方式</span><br><span class="line">SELECT @@AUTOCOMMIT;</span><br><span class="line">-- 设置事务提交方式，1为自动提交，0为手动提交，该设置只对当前会话有效</span><br><span class="line">SET @@AUTOCOMMIT = 0;</span><br><span class="line">-- 提交事务</span><br><span class="line">COMMIT;</span><br><span class="line">-- 回滚事务</span><br><span class="line">ROLLBACK;</span><br><span class="line"></span><br><span class="line">-- 设置手动提交后上面代码改为：</span><br><span class="line">select * from account where name = &#x27;张三&#x27;;</span><br><span class="line">update account set money = money - 1000 where name = &#x27;张三&#x27;;</span><br><span class="line">update account set money = money + 1000 where name = &#x27;李四&#x27;;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>

<p>操作方式二：</p>
<p>开启事务：<br><code>START TRANSACTION 或 BEGIN TRANSACTION;</code><br>提交事务：<br><code>COMMIT;</code><br>回滚事务：<br><code>ROLLBACK;</code></p>
<p>操作实例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">start transaction;</span><br><span class="line">select * from account where name = &#x27;张三&#x27;;</span><br><span class="line">update account set money = money - 1000 where name = &#x27;张三&#x27;;</span><br><span class="line">update account set money = money + 1000 where name = &#x27;李四&#x27;;</span><br><span class="line">commit;</span><br></pre></td></tr></table></figure>



<h2 id="1-四大特性ACID"><a href="#1-四大特性ACID" class="headerlink" title="1.四大特性ACID"></a>1.四大特性ACID</h2><ul>
<li>原子性(Atomicity)：事务是不可分割的最小操作但愿，要么全部成功，要么全部失败</li>
<li>一致性(Consistency)：事务完成时，必须使所有数据都保持一致状态</li>
<li>隔离性(Isolation)：数据库系统提供的隔离机制，保证事务在不受外部并发操作影响的独立环境下运行</li>
<li>持久性(Durability)：事务一旦提交或回滚，它对数据库中的数据的改变就是永久的</li>
</ul>
<h2 id="2-并发事务"><a href="#2-并发事务" class="headerlink" title="2.并发事务"></a>2.并发事务</h2><table>
<thead>
<tr>
<th>问题</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>脏读</td>
<td>一个事务读到另一个事务还没提交的数据</td>
</tr>
<tr>
<td>不可重复读</td>
<td>一个事务先后读取同一条记录，但两次读取的数据不同</td>
</tr>
<tr>
<td>幻读</td>
<td>一个事务按照条件查询数据时，没有对应的数据行，但是再插入数据时，又发现这行数据已经存在</td>
</tr>
</tbody></table>
<p>①脏读（Dirty read）：</p>
<p>​	数据库中A&#x3D;200，事务1中修改了A&#x3D;100，但是这时候事务1还没有commit，而此时事务2要读取A的值，事务2读取A&#x3D;100，这是事务A修改了但是还没有commit的数据，这种数据就称为’脏数据’，此时就发生了<code>脏读</code>。</p>
<p>②不可重复读（Unrepeatable read）</p>
<p>​	数据库中id&#x3D;1的数据有一个值为A&#x3D;200，事务A第一次select<code>id=1</code>的数据查询出A&#x3D;200，此时事务2修改update<code>id=1</code>的数据使A&#x3D;100并且commit了，此时数据库中的<code>id=1</code>的数据A&#x3D;100，然后事务1第二次读取select<code>id=1</code>的数据查询出A&#x3D;100和第一次查询出的A&#x3D;200不一致，此时就发生了<code>不可重复读现象</code>。</p>
<p>③幻读（Phantom read）</p>
<p>​	幻读与不可重复读类似，事务1第一步select查询id&#x3D;1的数据，此时数据库为空没有查到，刚好此时事务2向数据库中插入了id&#x3D;1的数据，此时事务1第二步要插入id&#x3D;1的数据的时候就会报错，当事务1再次查询数据库的时候发现id为1的数据还是没有（因为已经解决了不可重复读的问题，两次查询的结果一致），这时候就发生了’幻读’。因为在插入数据的时候会因为事务2插入的数据失败，事务1会发现已经有了插入的数据，但是查询的时候又看见，就像幻觉一样<code>Phantom</code>。</p>
<p>④丢失更新（Lost to modify）</p>
<p>事务1想要修改A&#x3D;20并且读取到了A&#x3D;20数据（此时事务2页读取到了A&#x3D;20），使A&#x3D;A-1，修改的结果为19；事务2读取到A&#x3D;20数据后也要进行修改，使A&#x3D;A-3，得到的结果为17；最终结果为17，看起来就是事务1的结果丢失了。</p>
<p>注：</p>
<ol>
<li>不可重复读和幻读类似，不可重复读是发生在事务A因为事务B的修改导致两次read的数据不一致，幻读是因为事务A因为事务B的插入数据导致自身插入数据失败，但是两次查询（特别是第二次）发现没有数据（解决了不可重复度的基础上），好像出现了幻觉。</li>
</ol>
<blockquote>
<p>这三个问题的详细演示：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Kr4y1i7ru?p=55cd">https://www.bilibili.com/video/BV1Kr4y1i7ru?p=55cd</a> </p>
<p>丢失更新相关博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/sun8112133/article/details/89853755">https://blog.csdn.net/sun8112133/article/details/89853755</a></p>
</blockquote>
<p>并发事务隔离级别：</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody><tr>
<td>Read uncommitted</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>Read committed</td>
<td>×</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>Repeatable Read(默认)</td>
<td>×</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>Serializable</td>
<td>×</td>
<td>×</td>
<td>×</td>
</tr>
</tbody></table>
<ul>
<li>√表示在当前隔离级别下该问题会出现</li>
<li>Serializable 性能最低；Read uncommitted 性能最高，数据安全性最差</li>
</ul>
<p>查看事务隔离级别：<br><code>SELECT @@TRANSACTION_ISOLATION;</code><br>设置事务隔离级别：<br><code>SET [ SESSION | GLOBAL ] TRANSACTION ISOLATION LEVEL &#123;READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE &#125;;</code><br>SESSION 是会话级别，表示只针对当前会话有效，GLOBAL 表示对所有会话有效</p>
<h1 id="二、存储引擎"><a href="#二、存储引擎" class="headerlink" title="二、存储引擎"></a>二、存储引擎</h1><h2 id="1-MySQL体系结构"><a href="#1-MySQL体系结构" class="headerlink" title="1. MySQL体系结构"></a>1. MySQL体系结构</h2><p><img src="https://s2.loli.net/2022/06/04/6zLJYsUrRBe2ZNT.png" alt="image-20220604151019471"><br><img src="https://s2.loli.net/2022/06/04/YBGfNA1QK29bsaF.png" alt="image-20220604150959201"></p>
<p>Mysql结构（4层）：</p>
<p>①连接层</p>
<p>​	处理来自各个客户端的连接（验证密码等），授权认证及相关安全信息</p>
<p>②服务层</p>
<p>​	最核心的一层，mysql在这一层中完成各类服务，执行sql、sql分析和优化，过程函数都在这一层实行</p>
<p>③引擎层</p>
<p>​	mysql实现的是可插拔存储引擎，想用哪个插哪个，默认为InnoDB。同时<code>索引(index)</code>也在这一层，所以各个存储引擎实现索引的方式可能不一样。存储引擎是数据库存储数据、建立索引、更新&#x2F;查询等技术的实现方式，存储引擎是基于表的</p>
<p>④存储层</p>
<p>​	主要是将存储的数据存入系统硬盘上，完成与存储引擎的交互</p>
<p>存储引擎就是存储数据、建立索引、更新&#x2F;查询数据等技术的实现方式。存储引擎是基于表而不是基于库的，所以存储引擎也可以被称为表引擎。<br>默认存储引擎是InnoDB。</p>
<p>相关操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-- 查询建表语句</span><br><span class="line">show create table account;</span><br><span class="line">-- 建表时指定存储引擎</span><br><span class="line">CREATE TABLE 表名(</span><br><span class="line">	...</span><br><span class="line">) ENGINE=INNODB;</span><br><span class="line">-- 查看当前数据库支持的存储引擎</span><br><span class="line">show engines;</span><br></pre></td></tr></table></figure>



<h2 id="2-常见引擎"><a href="#2-常见引擎" class="headerlink" title="2. 常见引擎"></a>2. 常见引擎</h2><h3 id="1）InnoDB"><a href="#1）InnoDB" class="headerlink" title="1）InnoDB"></a>1）InnoDB</h3><p>InnoDB 是一种兼顾高可靠性和高性能的通用存储引擎，在 MySQL 5.5 之后，InnoDB 是默认的 MySQL 引擎。</p>
<p>特点：</p>
<ul>
<li>DML 操作遵循 ACID 模型，支持<strong>事务</strong></li>
<li><strong>行级锁</strong>，提高并发访问性能</li>
<li>支持<strong>外键</strong>约束，保证数据的完整性和正确性</li>
</ul>
<p>文件：</p>
<ul>
<li>xxx.ibd: xxx代表表名，InnoDB 引擎的每张表都会对应这样一个表空间文件，存储该表的表结构（frm、sdi）、数据和索引。</li>
</ul>
<p>参数：innodb_file_per_table，决定多张表共享一个表空间还是每张表对应一个表空间</p>
<p>知识点：</p>
<p>查看 Mysql 变量：<br><code>show variables like &#39;innodb_file_per_table&#39;;</code></p>
<p>从idb文件提取表结构数据：<br>（在cmd运行）<br><code>ibd2sdi xxx.ibd</code></p>
<p>InnoDB 逻辑存储结构：</p>
<p><img src="https://s2.loli.net/2022/06/04/FnZ4XWVfNEJ5k9h.png" alt="image-20220604151045297"></p>
<h3 id="2）MyISAM"><a href="#2）MyISAM" class="headerlink" title="2）MyISAM"></a>2）MyISAM</h3><p>MyISAM 是 MySQL 早期的默认存储引擎。</p>
<p>特点：</p>
<ul>
<li>不支持事务，不支持外键</li>
<li>支持表锁，不支持行锁</li>
<li>访问速度快</li>
</ul>
<p>文件：</p>
<ul>
<li>xxx.sdi: 存储表结构信息</li>
<li>xxx.MYD: 存储数据</li>
<li>xxx.MYI: 存储索引</li>
</ul>
<h3 id="3）Memory"><a href="#3）Memory" class="headerlink" title="3）Memory"></a>3）Memory</h3><p>Memory 引擎的表数据是存储在内存中的，受硬件问题、断电问题的影响，只能将这些表作为临时表或缓存使用。</p>
<p>特点：</p>
<ul>
<li>存放在内存中，速度快</li>
<li>hash索引（默认）</li>
</ul>
<p>文件：</p>
<ul>
<li>xxx.sdi: 存储表结构信息</li>
</ul>
<h2 id="3-存储引擎特点比较"><a href="#3-存储引擎特点比较" class="headerlink" title="3. 存储引擎特点比较"></a>3. 存储引擎特点比较</h2><table>
<thead>
<tr>
<th>特点</th>
<th>InnoDB</th>
<th>MyISAM</th>
<th>Memory</th>
</tr>
</thead>
<tbody><tr>
<td>存储限制</td>
<td>64TB</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td>事务安全</td>
<td>支持</td>
<td>-</td>
<td>-</td>
</tr>
<tr>
<td>锁机制</td>
<td>行锁</td>
<td>表锁</td>
<td>表锁</td>
</tr>
<tr>
<td>B+tree索引</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>Hash索引</td>
<td>-</td>
<td>-</td>
<td>支持</td>
</tr>
<tr>
<td>全文索引</td>
<td>支持（5.6版本之后）</td>
<td>支持</td>
<td>-</td>
</tr>
<tr>
<td>空间使用</td>
<td>高</td>
<td>低</td>
<td>N&#x2F;A</td>
</tr>
<tr>
<td>内存使用</td>
<td>高</td>
<td>低</td>
<td>中等</td>
</tr>
<tr>
<td>批量插入速度</td>
<td>低</td>
<td>高</td>
<td>高</td>
</tr>
<tr>
<td>支持外键</td>
<td>支持</td>
<td>-</td>
<td>-</td>
</tr>
</tbody></table>
<h2 id="4-存储引擎的选择"><a href="#4-存储引擎的选择" class="headerlink" title="4. 存储引擎的选择"></a>4. 存储引擎的选择</h2><p>在选择存储引擎时，应该根据应用系统的特点选择合适的存储引擎。对于复杂的应用系统，还可以根据实际情况选择多种存储引擎进行组合。</p>
<ul>
<li>InnoDB: 如果应用对事物的完整性有比较高的要求，在并发条件下要求数据的一致性，数据操作除了插入和查询之外，还包含很多的更新、删除操作，则 InnoDB 是比较合适的选择</li>
<li>MyISAM: 如果应用是以读操作和插入操作为主，只有很少的更新和删除操作，并且对事务的完整性、并发性要求不高，那这个存储引擎是非常合适的。</li>
<li>Memory: 将所有数据保存在内存中，访问速度快，通常用于临时表及缓存。Memory 的缺陷是对表的大小有限制，太大的表无法缓存在内存中，而且无法保障数据的安全性</li>
</ul>
<p>电商中的足迹和评论适合使用 MyISAM 引擎，缓存适合使用 Memory 引擎。</p>
<h1 id="三、-索引"><a href="#三、-索引" class="headerlink" title="三、 索引"></a>三、 索引</h1><h2 id="1-索引结构"><a href="#1-索引结构" class="headerlink" title="1. 索引结构"></a>1. 索引结构</h2><table>
<thead>
<tr>
<th>索引结构</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>B+Tree</td>
<td>最常见的索引类型，大部分引擎都支持B+树索引</td>
</tr>
<tr>
<td>Hash</td>
<td>底层数据结构是用哈希表实现，只有精确匹配索引列的查询才有效，不支持范围查询</td>
</tr>
<tr>
<td>R-Tree(空间索引)</td>
<td>空间索引是 MyISAM 引擎的一个特殊索引类型，主要用于地理空间数据类型，通常使用较少</td>
</tr>
<tr>
<td>Full-Text(全文索引)</td>
<td>是一种通过建立倒排索引，快速匹配文档的方式，类似于 Lucene, Solr, ES</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>索引</th>
<th>InnoDB</th>
<th>MyISAM</th>
<th>Memory</th>
</tr>
</thead>
<tbody><tr>
<td>B+Tree索引</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>Hash索引</td>
<td>不支持</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>R-Tree索引</td>
<td>不支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>Full-text</td>
<td>5.6版本后支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
</tbody></table>
<h3 id="1）二叉搜索树"><a href="#1）二叉搜索树" class="headerlink" title="1）二叉搜索树"></a>1）二叉搜索树</h3><p><img src="https://s2.loli.net/2022/06/04/UFR5N6rMGEKVnIs.png" alt="image-20220604151133266"></p>
<p>二叉树的缺点可以用红黑树来解决：<br><img src="https://s2.loli.net/2022/06/04/9cftzj5epWYIF6V.png" alt="image-20220604151200671"><br>红黑树也存在大数据量情况下，层级较深，检索速度慢的问题。</p>
<h3 id="2）B-Tree"><a href="#2）B-Tree" class="headerlink" title="2）B Tree"></a>2）B Tree</h3><p>B Tree相较于二叉搜索树维护了自平衡（左右高度差距不会过大）并且增加了一个节点的字节点数量，eg：</p>
<p>如下图degree&#x3D;5（子节点个数），一共可存4个key（值），<code>x</code>&lt;20，20&lt;&#x3D;<code>x</code>&lt;30，…，…，89&#x3D;&lt;x</p>
<p>为了解决上述问题，可以使用 B-Tree 结构：</p>
<p>​	B-Tree (多路平衡查找树) 以一棵最大度数（max-degree，指一个节点的子节点个数）为5（5阶）的 b-tree 为例（每个节点最多存储4个key，5个指针）</p>
<p><img src="https://s2.loli.net/2022/06/04/1kgTeC5UNWFiEIf.png" alt="image-20220604151214322"></p>
<blockquote>
<p>B-Tree 的数据插入过程动画参照：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Kr4y1i7ru?p=68">https://www.bilibili.com/video/BV1Kr4y1i7ru?p=68</a><br>演示地址：<a target="_blank" rel="noopener" href="https://www.cs.usfca.edu/~galles/visualization/BTree.html">https://www.cs.usfca.edu/~galles/visualization/BTree.html</a></p>
</blockquote>
<h3 id="3）B-Tree"><a href="#3）B-Tree" class="headerlink" title="3）B+Tree"></a>3）B+Tree</h3><p>B+ Tree 相较于B Tree就是将数据全部存储在了叶子节点，如下图左下角x&lt;16，16&lt;&#x3D;x&lt;29，29&lt;&#x3D;x</p>
<p>这样key&#x3D;16的数据就存储在了第二个叶子节点</p>
<p>结构图：</p>
<p><img src="https://s2.loli.net/2022/06/04/Q21ABD6jfdZPi8p.png" alt="image-20220604151223679"></p>
<blockquote>
<p>演示地址：<a target="_blank" rel="noopener" href="https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html">https://www.cs.usfca.edu/~galles/visualization/BPlusTree.html</a></p>
</blockquote>
<p>与 B Tree 的区别：</p>
<ul>
<li>所有的数据都会出现在叶子节点</li>
<li>叶子节点形成一个单向链表</li>
</ul>
<h3 id="4）InooDB的改进B-Tree"><a href="#4）InooDB的改进B-Tree" class="headerlink" title="4）InooDB的改进B+ Tree"></a>4）InooDB的改进B+ Tree</h3><p>MySQL 索引数据结构对经典的 B+Tree 进行了优化。在原 B+Tree 的基础上，增加一个指向相邻叶子节点的链表指针，就形成了带有顺序指针的 B+Tree，提高区间访问的性能。</p>
<p><img src="https://s2.loli.net/2022/06/04/aKtQdNDGo6iLmEC.png" alt="image-20220604151239993"></p>
<p>​	mysql中的B+树对经典的B+树做了优化，1.在叶子相邻叶子节点间添加了一个向前的指针使其成为了双向链表（首尾也是双向指针），这是便于<code>范围搜索</code>和<code>排序</code></p>
<h3 id="5）Hash索引"><a href="#5）Hash索引" class="headerlink" title="5）Hash索引"></a>5）Hash索引</h3><p>哈希索引就是采用一定的hash算法，将键值换算成新的hash值，映射到对应的槽位上，然后存储在hash表中。<br>如果两个（或多个）键值，映射到一个相同的槽位上，他们就产生了hash冲突（也称为hash碰撞），可以通过链表来解决。</p>
<p><img src="https://s2.loli.net/2022/06/04/z2J1p8j9EChBwcN.png" alt="image-20220604151249990"></p>
<p>特点：</p>
<ul>
<li>Hash索引只能用于对等比较（&#x3D;、in），不支持范围查询（betwwn、&gt;、&lt;、…）</li>
<li>无法利用索引完成排序操作</li>
<li>查询效率高，通常只需要一次检索就可以了，效率通常要高于 B+Tree 索引</li>
</ul>
<p>存储引擎支持：</p>
<ul>
<li>Memory</li>
<li>InnoDB: 具有自适应hash功能，hash索引是存储引擎根据 B+Tree 索引在指定条件下自动构建的</li>
</ul>
<h3 id="6）面试题"><a href="#6）面试题" class="headerlink" title="6）面试题"></a>6）面试题</h3><ol>
<li>为什么 InnoDB 存储引擎选择使用 B+Tree 索引结构？</li>
</ol>
<ul>
<li>相对于二叉树，层级更少，搜索效率高</li>
<li>对于 B-Tree，无论是叶子节点还是非叶子节点，都会保存数据，这样导致一页中存储的键值减少，指针也跟着减少，要同样保存大量数据，只能增加树的高度，导致性能降低</li>
<li>相对于 Hash 索引，B+Tree 支持范围匹配及排序操作</li>
<li>mine：<ul>
<li><img src="https://s2.loli.net/2022/04/30/ocWZvNhuSs1VBgt.png" alt="image-20220429152507413"></li>
<li>二叉搜索树在顺序插入的时候会形成一个链表，查询的过程就变成线性的一条一条查询；如果数据量较大，层级变深，搜索效率变慢</li>
<li>B Tree 无论节点还是非叶子节点都会保存数据，而每一个节点都是存储在一页中的，如果非叶子节点要保存value，那么这一页存储的keys就会减少，指针也变少了，要存储更多的数据，只能增加树的高度，导致性能降低了</li>
<li>同时因为改进后的B+树在叶子节点间添加了双向指针，便于范围匹配和排序，而Hash索引不能</li>
</ul>
</li>
</ul>
<h2 id="2-索引分类"><a href="#2-索引分类" class="headerlink" title="2. 索引分类"></a>2. 索引分类</h2><h3 id="1）基本结构"><a href="#1）基本结构" class="headerlink" title="1）基本结构"></a>1）基本结构</h3><table>
<thead>
<tr>
<th>分类</th>
<th>含义</th>
<th>特点</th>
<th>关键字</th>
</tr>
</thead>
<tbody><tr>
<td>主键索引</td>
<td>针对于表中主键创建的索引</td>
<td>默认自动创建，只能有一个</td>
<td>PRIMARY</td>
</tr>
<tr>
<td>唯一索引</td>
<td>避免同一个表中某数据列中的值重复</td>
<td>可以有多个</td>
<td>UNIQUE</td>
</tr>
<tr>
<td>常规索引</td>
<td>快速定位特定数据</td>
<td>可以有多个</td>
<td></td>
</tr>
<tr>
<td>全文索引</td>
<td>全文索引查找的是文本中的关键词，而不是比较索引中的值</td>
<td>可以有多个</td>
<td>FULLTEXT</td>
</tr>
</tbody></table>
<p>在 InnoDB 存储引擎中，根据索引的存储形式，又可以分为以下两种：</p>
<table>
<thead>
<tr>
<th>分类</th>
<th>含义</th>
<th>特点</th>
</tr>
</thead>
<tbody><tr>
<td>聚集索引(Clustered Index)</td>
<td>将数据存储与索引放一块，索引结构的叶子节点保存了行数据</td>
<td>必须有，而且只有一个</td>
</tr>
<tr>
<td>二级索引(Secondary Index)</td>
<td>将数据与索引分开存储，索引结构的叶子节点关联的是对应的主键</td>
<td>可以存在多个</td>
</tr>
</tbody></table>
<p>演示图：</p>
<p><img src="https://s2.loli.net/2022/06/04/KwRVxtr2qhoFd7g.png" alt="image-20220604151410748"><br><img src="https://s2.loli.net/2022/06/04/WGJnCjK37u2v68o.png" alt="image-20220604151429077"></p>
<p>聚集索引选取规则：</p>
<ul>
<li>如果存在主键，主键索引就是聚集索引</li>
<li>如果不存在主键，将使用第一个唯一(UNIQUE)列作为聚集索引</li>
<li>如果表没有主键或没有合适的唯一索引，则 InnoDB 会自动生成一个 rowid 作为隐藏的聚集索引</li>
</ul>
<h3 id="2）思考题"><a href="#2）思考题" class="headerlink" title="2）思考题"></a>2）思考题</h3><p>1. 以下 SQL 语句，哪个执行效率高？为什么？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select * from user where id = 10;</span><br><span class="line">select * from user where name = &#x27;Arm&#x27;;</span><br><span class="line">-- 备注：id为主键，name字段创建的有索引</span><br></pre></td></tr></table></figure>

<p>答：第一条语句，因为第二条需要回表查询，相当于两个步骤。</p>
<p>2. InnoDB 主键索引的 B+Tree 高度为多少？</p>
<p>答：假设一行数据大小为1k，一页中可以存储16行这样的数据。InnoDB 的指针占用6个字节的空间，主键假设为bigint，占用字节数为8.<br>可得公式：<code>n * 8 + (n + 1) * 6 = 16 * 1024</code>，其中 8 表示 bigint 占用的字节数，n 表示当前节点存储的key的数量，(n + 1) 表示指针数量（比key多一个）。算出n约为1170。</p>
<p>如果树的高度为2，那么他能存储的数据量大概为：<code>1171 * 16 = 18736</code>；<br>如果树的高度为3，那么他能存储的数据量大概为：<code>1171 * 1171 * 16 = 21939856</code>。</p>
<p>另外，如果有成千上万的数据，那么就要考虑分表</p>
<h2 id="3-索引语法"><a href="#3-索引语法" class="headerlink" title="3. 索引语法"></a>3. 索引语法</h2><p>创建索引：<br><code>CREATE [ UNIQUE | FULLTEXT ] INDEX index_name ON table_name (index_col_name, ...);</code><br>如果不加 CREATE 后面不加索引类型参数，则创建的是常规索引</p>
<p>查看索引：<br><code>SHOW INDEX FROM table_name;</code></p>
<p>删除索引：<br><code>DROP INDEX index_name ON table_name;</code></p>
<p>案例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-- name字段为姓名字段，该字段的值可能会重复，为该字段创建索引</span><br><span class="line">create index idx_user_name on tb_user(name);</span><br><span class="line">-- phone手机号字段的值非空，且唯一，为该字段创建唯一索引</span><br><span class="line">create unique index idx_user_phone on tb_user (phone);</span><br><span class="line">-- 为profession, age, status创建联合索引</span><br><span class="line">create index idx_user_pro_age_stat on tb_user(profession, age, status);</span><br><span class="line">-- 为email建立合适的索引来提升查询效率</span><br><span class="line">create index idx_user_email on tb_user(email);</span><br><span class="line"></span><br><span class="line">-- 删除索引</span><br><span class="line">drop index idx_user_email on tb_user;</span><br></pre></td></tr></table></figure>



<h2 id="4-sql性能分析"><a href="#4-sql性能分析" class="headerlink" title="4. sql性能分析"></a>4. sql性能分析</h2><p>①首先查看执行频次来分析当前数据库，是增删改语句执行的多，还是select语句执行的多</p>
<p>②通过慢查询日志可以定位哪台主机通过哪个user执行了哪条<code>sql语句</code>，执行效率较低</p>
<p>③慢查询日志只会记录超过设定时间的sql，如果要查看没有超过时限的sql则需要通过profiles来查询</p>
<p>④explain会查看sql具体的执行信息</p>
<h3 id="1）查看执行频次"><a href="#1）查看执行频次" class="headerlink" title="1）查看执行频次"></a>1）查看执行频次</h3><p>查看当前数据库的 INSERT, UPDATE, DELETE, SELECT 访问频次：<br><code>全局：SHOW GLOBAL STATUS LIKE &#39;Com_______&#39;;</code> </p>
<p><code>会话：SHOW SESSION STATUS LIKE &#39;Com_______&#39;;</code></p>
<p>例：<code>show global status like &#39;Com_______&#39;</code></p>
<h3 id="2）慢查询日志"><a href="#2）慢查询日志" class="headerlink" title="2）慢查询日志"></a>2）慢查询日志</h3><p>慢查询日志记录了所有执行时间超过指定参数（long_query_time，单位：秒，默认10秒）的所有SQL语句的日志。<br>MySQL的慢查询日志默认没有开启，需要在MySQL的配置文件（&#x2F;etc&#x2F;my.cnf）中配置如下信息：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#开启慢查询日志开关</span></span><br><span class="line"><span class="attr">slow_query_log</span>=<span class="string">1</span></span><br><span class="line"><span class="comment">#设置慢查询日志的时间为2秒，SQL语句执行时间超过2秒，就会视为慢查询，记录慢查询日志：</span></span><br><span class="line"><span class="attr">long_query_time</span>=<span class="string">2</span></span><br></pre></td></tr></table></figure>

<p>更改后重启MySQL服务，日志文件位置：&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;localhost-slow.log</p>
<p><code>systemctl restart mysqld</code></p>
<p>查看慢查询日志开关状态：</p>
<p><code>show variables like &#39;slow_query_log&#39;;</code></p>
<h3 id="3）profile"><a href="#3）profile" class="headerlink" title="3）profile"></a>3）profile</h3><p>show profile 能在做SQL优化时帮我们了解时间都耗费在哪里。通过 have_profiling 参数，能看到当前 MySQL 是否支持 profile 操作：</p>
<p><code>SELECT @@have_profiling;</code></p>
<p>profiling 默认关闭，可查询其开启情况（0是关闭）</p>
<p><code>select @@profiling;</code></p>
<p>可以通过set语句在session&#x2F;global级别开启 profiling：</p>
<p><code>SET profiling = 1;</code></p>
<p>查看所有语句的耗时：</p>
<p><code>show profiles;</code></p>
<p>查看指定query_id的SQL语句各个阶段的耗时：</p>
<p><code>show profile for query query_id;</code></p>
<p>查看指定query_id的SQL语句CPU的使用情况</p>
<p><code>show profile cpu for query query_id;</code></p>
<h3 id="4）explain"><a href="#4）explain" class="headerlink" title="4）explain"></a>4）explain</h3><p>EXPLAIN 或者 DESC 命令获取 MySQL 如何执行 SELECT 语句的信息，包括在 SELECT 语句执行过程中表如何连接和连接的顺序。<br>语法：<br>    # 直接在select语句之前加上关键字 explain &#x2F; desc<br>    EXPLAIN SELECT 字段列表 FROM 表名 HWERE 条件;</p>
<p>EXPLAIN 各字段含义：</p>
<ul>
<li><p><strong>id</strong>：select </p>
<ul>
<li>查询的序列号，表示查询中执行 select 子句或者操作表的顺序（id相同，执行顺序从上到下；id不同，值越大越先执行）</li>
</ul>
</li>
<li><p>select_type：</p>
<ul>
<li>表示 SELECT 的类型，常见取值有 SIMPLE（简单表，即不适用表连接或者子查询）、PRIMARY（主查询，即外层的查询）、UNION（UNION中的第二个或者后面的查询语句）、SUBQUERY（SELECT&#x2F;WHERE之后包含了子查询）等</li>
</ul>
</li>
<li><p><strong>type</strong>：</p>
<ul>
<li>表示连接类型，性能由好到差的连接类型为 NULL、system、const、eq_ref、ref、range、index、all</li>
<li>用主键索引或者唯一索引查询，const</li>
<li>用普通索引，ref</li>
<li>select ‘A’，NULL</li>
</ul>
</li>
<li><p><strong>possible_key</strong>：</p>
<ul>
<li>可能应用在这张表上的索引，一个或多个</li>
</ul>
</li>
<li><p><strong>Key</strong>：</p>
<ul>
<li>实际使用的索引，如果为 NULL，则没有使用索引</li>
</ul>
</li>
<li><p><strong>Key_len</strong>：</p>
<ul>
<li>表示索引中使用的字节数，该值为索引字段最大可能长度，并非实际使用长度，在不损失精确性的前提下，长度越短越好</li>
</ul>
</li>
<li><p>rows：</p>
<ul>
<li>MySQL认为必须要执行的行数，在InnoDB引擎的表中，是一个估计值，可能并不总是准确的</li>
</ul>
</li>
<li><p>filtered：</p>
<ul>
<li>表示返回结果的行数占需读取行数的百分比，filtered的值越大越好</li>
</ul>
</li>
</ul>
<h2 id="5-使用规则"><a href="#5-使用规则" class="headerlink" title="5. 使用规则"></a>5. 使用规则</h2><h3 id="1）最左前缀法则（联合索引）"><a href="#1）最左前缀法则（联合索引）" class="headerlink" title="1）最左前缀法则（联合索引）"></a>1）最左前缀法则（联合索引）</h3><p>如果索引关联了多列（联合索引），要遵守最左前缀法则，最左前缀法则指的是查询从索引的最左列开始，并且不跳过索引中的列。<br>如果跳跃某一列，索引将部分失效（后面的字段索引失效）。</p>
<p>联合索引中，出现范围查询（&lt;, &gt;），范围查询右侧的列索引失效。可以用&gt;&#x3D;或者&lt;&#x3D;来规避索引失效问题。</p>
<p><img src="https://s2.loli.net/2022/06/04/brk8NdOZXlhq23t.png" alt="image-20220430160710489"></p>
<p>​	在这样一条联合索引中，索引的顺序分别是：profession（47），age（2），status（5），</p>
<ul>
<li><p>profession列一定存在，但在where中的顺序不影响</p>
<p><img src="https://s2.loli.net/2022/04/30/zqmAFYeTyiXBrNl.png" alt="image-20220430160919490"></p>
<ul>
<li>这样两条sql都会走该联合索引，只是索引长度可能不一致，第一条会按顺序查询 pro，age，status三条索引（54）</li>
<li>下面一条没有status，只会顺序查询pro，age两条索引（49）</li>
</ul>
</li>
<li><p>中间跳过某一列后，后面的索引就会失效</p>
<p><img src="https://s2.loli.net/2022/04/30/AnONs5KXudJpZgv.png" alt="image-20220430161324620"></p>
<ul>
<li><p>这样两条sql都会走联合查询，因为有pro在（最左边的列在）（where后and的顺序不重要）</p>
</li>
<li><p>但是只会查询pro索引，因为跳过了中间的age索引（没有），那么age后status索引也不会查询（47）</p>
</li>
<li><p>可以这样说：age单说是没有索引的，因为如果只根据age去查，没有pro的话，age的索引也不会用到</p>
</li>
<li><p>注：如果select字段中包含了该联合查询的字段而不需要回表查询也会使用联合查询</p>
<p><img src="https://s2.loli.net/2022/04/30/AgFNWb4lrUYofGe.png" alt="image-20220430182127493"></p>
<p><img src="https://s2.loli.net/2022/04/30/VRtgf75F6iyTZXM.png" alt="image-20220430182201299"></p>
</li>
</ul>
</li>
</ul>
<p>​				因为select字段在pro_age_sta的联合索引中都含有，而id则是联合索引的叶子节点值，所以通过索引能将这些值全部查询出来，这样就会使用索引，虽然不满足最左前缀原则，之前不使用是因为select * ，不能直接通过该联合索引获取所有值，需要回表查询</p>
<p>联合索引失效tips：</p>
<ul>
<li><p>跳过联合索引中的某一列，该列右边的所有索引都会失效</p>
</li>
<li><p>若在索引上使用了&gt;，&lt; 等范围查询会让该索引右边的列索引失效（自身不会失效）</p>
<p><img src="https://s2.loli.net/2022/04/30/oej2vmnNVUDzhWZ.png" alt="image-20220430162904070"></p>
<ul>
<li><p>上面这条查询会查询pro，age，但是age使用了范围查询&gt;，所以age不会失效，status索引会失效（49）</p>
</li>
<li><p>解决办法：在业务允许的情况下，尽量使用&gt;&#x3D;和&lt;&#x3D;</p>
<p><img src="https://s2.loli.net/2022/04/30/IyqERfjPizUQOSs.png" alt="image-20220430163118495"></p>
</li>
<li><p>这样查询就会查询pro，age，status三条索引</p>
</li>
</ul>
</li>
</ul>
<p>​			</p>
<h3 id="2）普通索引失效情况"><a href="#2）普通索引失效情况" class="headerlink" title="2）普通索引失效情况"></a>2）普通索引失效情况</h3><ol>
<li><p>在索引列上进行运算操作（如函数运算），索引将失效。</p>
<p>如：查询手机号后两位是15的用户</p>
<p><code>explain select * from tb_user where substring(phone, 10, 2) = &#39;15&#39;;</code></p>
<p>这样不会走phone索引，因为在phone索引上进行了函数运算</p>
</li>
<li><p>字符串类型字段使用时，不加引号，索引将失效。</p>
<p>如：<code>explain select * from tb_user where phone = 17799990015;</code>，此处phone的值没有加引号</p>
<p>虽然可以查询出来，但是并不会走phone的索引</p>
</li>
<li><p>模糊查询中，如果仅仅是尾部模糊匹配，索引不会是失效；如果是头部模糊匹配，索引失效。</p>
<p>如：<code>explain select * from tb_user where profession like &#39;%工程&#39;;</code> 前面有%会失效</p>
<p>​	    <code>explain select * from tb_user where profession like &#39;工程%&#39;;</code>后面有%不会失效</p>
<p>注：’_’ 和 ‘%’ 的情况是一样的</p>
</li>
<li><p>用 or 分割开的条件，如果 or 其中一个条件的列没有索引，那么涉及的索引都不会被用到。</p>
<p><img src="https://s2.loli.net/2022/04/30/6QNDVjHxdI5Fatu.png" alt="image-20220430165521463"><img src="https://s2.loli.net/2022/04/30/ez7OVMCQshElxrT.png" alt="image-20220430165544822"></p>
<p>如该条数据，可能会走主键索引，但是最后没走索引，因为age没有索引，解决办法就是为age添加上索引</p>
</li>
<li><p>如果 MySQL 评估使用索引比全表更慢，则不使用索引。</p>
<p>如：<code>explain select * from tb_user where profession is null;</code> pro字段只有少部分是null，所以会走索引</p>
</li>
</ol>
<p>​			   <code>explain select * from tb_user where profession is not null;</code> pro字段大部分都不是null，这样还不如扫描all，所以不会走索引</p>
<h3 id="3）SQL-提示"><a href="#3）SQL-提示" class="headerlink" title="3）SQL 提示"></a>3）SQL 提示</h3><p>​	是优化数据库的一个重要手段，简单来说，就是在SQL语句中加入一些人为的提示来达到优化操作的目的：</p>
<p>如用户告诉mysql在有多个索引的情况下，选择哪个索引而不是让mysql的优化选择器自己选择</p>
<p>例如：</p>
<ol>
<li><p>在可能多个索引的情况下：</p>
<p>使用哪个索引：</p>
<p><code>explain select * from tb_user use index(idx_user_pro) where profession=&quot;软件工程&quot;;</code></p>
<p>不使用哪个索引：</p>
<p><code>explain select * from tb_user ignore index(idx_user_pro) where profession=&quot;软件工程&quot;;</code></p>
<p>必须使用哪个索引：</p>
<p><code>explain select * from tb_user force index(idx_user_pro) where profession=&quot;软件工程&quot;;</code></p>
</li>
</ol>
<p>use 是建议，实际使用哪个索引 MySQL 还会自己权衡运行速度去更改，force就是无论如何都强制使用该索引。</p>
<h3 id="4）覆盖索引-amp-回表查询"><a href="#4）覆盖索引-amp-回表查询" class="headerlink" title="4）覆盖索引&amp;回表查询"></a>4）覆盖索引&amp;回表查询</h3><ul>
<li>覆盖索引：根据索引可以查询出所有数据</li>
</ul>
<p><img src="https://s2.loli.net/2022/04/30/LHd9CkzsG2rFv5p.png" alt="image-20220430184740825"></p>
<p><img src="https://s2.loli.net/2022/04/30/cCjQklvUs84A76o.png" alt="image-20220430184754971"></p>
<p>查询的数据中id值在该联合索引（二级索引）的叶子节点，所以只需要查一次联合索引就可以查询出所有值而不需要回表查询</p>
<ul>
<li>回表查询：二级索引不能查询出所有值，需要通过查询出的主键id来查询聚集索引获取值</li>
</ul>
<p><img src="https://s2.loli.net/2022/04/30/7MSNr4i3qFDPYb2.png" alt="image-20220430185245418"></p>
<p><img src="https://s2.loli.net/2022/04/30/75qcEWAOeDoXujJ.png" alt="image-20220430185302627"></p>
<p>虽然使用了索引查询，但是因为查询的字段中的gender和email是无法通过该联合索引查询出来的，所以在通过二级索引获取了id，profession，age后，还需要通过id值查询聚集索引来获取剩下的gender和email，这就进行了回表查询</p>
<h3 id="5）前缀索引"><a href="#5）前缀索引" class="headerlink" title="5）前缀索引"></a>5）前缀索引</h3><p>当字段类型为字符串（varchar, text等）时，如果在这些字段上建立索引会导致建立的索引较大，查询时，也会浪费大量的磁盘IO，影响</p>
<p>查询效率，此时可以只降字符串的一部分前缀，建立索引，这样可以大大节约索引空间，从而提高索引效率。</p>
<p>比如要在email上建立索引，我们可以截取email的前几个char作为索引，这样就可以减小索引长度，可以根据一个比值选择性k来判断取值的合理性：不同的subString&#x2F;all，eg：当我们截取email字段前5个的时候，10个email中8个的前5个char都不一样，只有两个的前5个char是一样的，这时候k&#x3D;8&#x2F;10&#x3D;0.8，我就可以在k和长度之间做取舍</p>
<p>求选择性公式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select count(distinct email) / count(*) from tb_user;</span><br><span class="line">select count(distinct substring(email, 1, 5)) / count(*) from tb_user;</span><br></pre></td></tr></table></figure>

<p>语法：<code>create index idx_xxxx on table_name(columnn(n));</code></p>
<p>show index 里面的sub_part可以看到接取的长度</p>
<h3 id="6）单列索引-amp-联合索引"><a href="#6）单列索引-amp-联合索引" class="headerlink" title="6）单列索引&amp;联合索引"></a>6）单列索引&amp;联合索引</h3><p>单列索引：即一个索引只包含单个列<br>联合索引：即一个索引包含了多个列<br>在业务场景中，如果存在多个查询条件，考虑针对于查询字段建立索引时，建议建立联合索引，而非单列索引。</p>
<p>单列索引情况：<br><code>explain select id, phone, name from tb_user where phone = &#39;17799990010&#39; and name = &#39;韩信&#39;;</code><br>这句只会用到phone索引字段，该sql会进行回表查询，因为phone的单列索引中并不包含name列</p>
<p>所以我们可以根据查询条件构建联合索引（注意顺序——最左前缀法则）</p>
<p><code>create index idx_user_phone_name on tb_user(phone,name);</code></p>
<p>注意事项</p>
<ul>
<li>多条件联合查询时，MySQL优化器会评估哪个字段的索引效率更高，会选择该索引完成本次查询</li>
</ul>
<h3 id="7）设计原则"><a href="#7）设计原则" class="headerlink" title="7）设计原则"></a>7）设计原则</h3><ol>
<li>针对于数据量较大，且查询比较频繁的表建立索引</li>
<li>针对于常作为查询条件（where）、排序（order by）、分组（group by）操作的字段建立索引</li>
<li>尽量选择区分度高的列作为索引，尽量建立唯一索引，区分度越高，使用索引的效率越高</li>
<li>如果是字符串类型的字段，字段长度较长，可以针对于字段的特点，建立前缀索引</li>
<li>尽量使用联合索引，减少单列索引，查询时，联合索引很多时候可以覆盖索引，节省存储空间，避免回表，提高查询效率</li>
<li>要控制索引的数量，索引并不是多多益善，索引越多，维护索引结构的代价就越大，会影响增删改的效率</li>
<li>如果索引列不能存储NULL值，请在创建表时使用NOT NULL约束它。当优化器知道每列是否包含NULL值时，它可以更好地确定哪个索引最有效地用于查询</li>
</ol>
<h1 id="四、-sql优化"><a href="#四、-sql优化" class="headerlink" title="四、 sql优化"></a>四、 sql优化</h1><p><img src="https://s2.loli.net/2022/05/04/TgKzdrDO5u6Mxf2.png" alt="image-20220503171504262"></p>
<h2 id="1-插入数据（insert，load）"><a href="#1-插入数据（insert，load）" class="headerlink" title="1.插入数据（insert，load）"></a>1.插入数据（insert，load）</h2><p>普通插入：</p>
<ol>
<li>采用批量插入（一次插入的数据不建议超过1000条）</li>
<li>手动提交事务（mysql默认自动提交事务，执行3条insert就会有三次事务，可以直接start transaction (3条insert) commit）</li>
<li>主键顺序插入</li>
</ol>
<p>大批量插入（load本地文件）：<br>如果一次性需要插入大批量数据，使用insert语句插入性能较低，此时可以使用MySQL数据库提供的load指令插入。</p>
<p>①客户端连接服务端时，加上参数 –local-infile（这一行在bash&#x2F;cmd界面输入）<br><code>mysql --local-infile -u root -p</code></p>
<p>②设置全局参数local_infile为1，开启从本地加载文件导入数据的开关</p>
<p><code>set global local_infile = 1;</code><br><code>select @@local_infile;</code></p>
<p>③执行load指令将准备好的数据，加载到表结构中</p>
<p><code>load data local infile &#39;/root/sql1.log&#39; into table &#39;tb_user&#39; fields terminated by &#39;,&#39; lines terminated by &#39;\n&#39;;</code></p>
<h2 id="2-页分裂和页合并"><a href="#2-页分裂和页合并" class="headerlink" title="2.页分裂和页合并"></a>2.页分裂和页合并</h2><p>数据组织方式：在InnoDB存储引擎中，表数据都是根据主键顺序组织存放的，这种存储方式的表称为索引组织表（Index organized table, IOT）</p>
<h4 id="①页分裂"><a href="#①页分裂" class="headerlink" title="①页分裂"></a>①页分裂</h4><p><img src="https://s2.loli.net/2022/05/03/ivgQnFRIlw8AuPS.png" alt="image-20220501184608187"></p>
<p><img src="https://s2.loli.net/2022/05/03/8NQSBUeDgXZ5Apy.png" alt="image-20220501184715525"></p>
<p>若不按顺序排列，在后面就会涉及到一个重新排序的页分裂动作</p>
<h4 id="②页合并"><a href="#②页合并" class="headerlink" title="②页合并"></a>②页合并</h4><p><img src="https://s2.loli.net/2022/05/03/RYzTaZNEGrg5xuk.png" alt="image-20220501184804556"></p>
<p>当删除一行记录时，实际上记录并没有被物理删除，只是记录被标记（flaged）为删除并且它的空间变得允许被其他记录声明使用。当页中删除的记录到达 MERGE_THRESHOLD（默认为页的50%），InnoDB会开始寻找最靠近的页（前后）看看是否可以将这两个页合并以优化空间使用。</p>
<p>如图中14，15，16三条数据已经被标记不被使用，如果此时page2的删除达到阈值，就会尝试将右边的17，18，19合并进一个page</p>
<p>MERGE_THRESHOLD：合并页的阈值，可以自己设置，在创建表或创建索引时指定</p>
<blockquote>
<p>文字说明不够清晰明了，具体可以看视频里的PPT演示过程：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Kr4y1i7ru?p=90">https://www.bilibili.com/video/BV1Kr4y1i7ru?p=90</a></p>
</blockquote>
<p>个主键设计原则：</p>
<ul>
<li><p>满足业务需求的情况下，尽量降低主键的长度</p>
<ul>
<li>二级索引叶子节点挂的是主键，如果主键较长，二级索引较大会占用IO，效率变低</li>
</ul>
</li>
<li><p>插入数据时，尽量选择顺序插入，选择使用 AUTO_INCREMENT 自增主键</p>
</li>
<li><p>尽量不要使用 UUID 做主键或者是其他的自然主键，如身份证号</p>
<ul>
<li>因为这些是无序插入，会产生页分裂现象，并且长度可能较长</li>
</ul>
</li>
<li><p>业务操作时，避免对主键的修改</p>
</li>
</ul>
<h2 id="3-order-by优化"><a href="#3-order-by优化" class="headerlink" title="3.order by优化"></a>3.order by优化</h2><ol>
<li>Using filesort：通过表的索引或全表扫描，读取满足条件的数据行，然后在排序缓冲区 sort buffer 中完成排序操作，所有不是通过索引直接返回排序结果的排序都叫 FileSort 排序</li>
<li>Using index：通过有序索引顺序扫描直接返回有序数据，这种情况即为 using index，不需要额外排序，操作效率高</li>
</ol>
<p>如果order by字段全部使用升序排序或者降序排序，则都会走索引，但是如果一个字段升序排序，另一个字段降序排序，则不会走索引，explain的extra信息显示的是<code>Using index, Using filesort</code>，如果要优化掉Using filesort，则需要另外再创建一个索引，如：<code>create index idx_user_age_phone_ad on tb_user(age asc, phone desc);</code>，此时使用<code>select id, age, phone from tb_user order by age asc, phone desc;</code>会全部走索引</p>
<p>总结：</p>
<ul>
<li><p>根据排序字段建立合适的索引，多字段排序时，也遵循最左前缀法则</p>
<ul>
<li>order by phone，age; 在index&#x3D;age，phone的情况下是不会使用索引的，因为首先按phone排序，但是索引第一个是age</li>
</ul>
</li>
<li><p>尽量使用覆盖索引</p>
</li>
<li><p>多字段排序，一个升序一个降序，此时需要注意联合索引在创建时的规则（ASC&#x2F;DESC）</p>
</li>
<li><p>如果不可避免出现filesort，大数据量排序时，可以适当增大排序缓冲区大小 sort_buffer_size（默认256k）</p>
</li>
</ul>
<h2 id="4-group-by优化"><a href="#4-group-by优化" class="headerlink" title="4.group by优化"></a>4.group by优化</h2><ul>
<li>在分组操作时，可以通过索引来提高效率</li>
<li>分组操作时，索引的使用也是满足最左前缀法则的</li>
</ul>
<p>如索引为<code>idx_user_pro_age_stat</code>，</p>
<p><code>select profession,age,coun(*) from tb_user group by profession</code> </p>
<p><code>select age where profession group by age</code> （where 后有了profession，也算是最左）</p>
<p>以上两条都符合最左前缀法则</p>
<p>注意：</p>
<p><code>explain select age,count(age) from tb_user group by age;</code></p>
<p>虽然也用到了索引，但是也用到了临时表，其实效率并不高</p>
<h2 id="5-limit优化"><a href="#5-limit优化" class="headerlink" title="5.limit优化"></a>5.limit优化</h2><p>常见的问题如<code>limit 2000000, 10</code>，此时需要 MySQL 排序前2000000条记录，但仅仅返回2000000 - 2000010的记录，其他记录丢弃，查询排序的代价非常大。<br>优化方案：一般分页查询时，通过创建覆盖索引能够比较好地提高性能，可以通过<code>覆盖索引</code>加<code>子查询</code>形式进行优化</p>
<p>例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-- 此语句耗时很长</span><br><span class="line">select * from tb_sku limit 9000000, 10;</span><br><span class="line">-- 通过覆盖索引加快速度，直接通过主键索引进行排序及查询</span><br><span class="line">select id from tb_sku order by id limit 9000000, 10;</span><br><span class="line">-- 下面的语句是错误的，因为 MySQL 不支持 in 里面使用 limit</span><br><span class="line">-- select * from tb_sku where id in (select id from tb_sku order by id limit 9000000, 10);</span><br><span class="line">-- 通过连表查询即可实现第一句的效果，并且能达到第二句的速度</span><br><span class="line">select * from tb_sku as s, (select id from tb_sku order by id limit 9000000, 10) as a where s.id = a.id;</span><br></pre></td></tr></table></figure>



<h2 id="6-count优化"><a href="#6-count优化" class="headerlink" title="6.count优化"></a>6.count优化</h2><p>MyISAM 引擎把一个表的总行数存在了磁盘上，因此执行 count(*) 的时候会直接返回这个数，效率很高（前提是不适用where）；<br>InnoDB 在执行 count(*) 时，需要把数据一行一行地从引擎里面读出来，然后累计计数。<br>优化方案：自己计数，如创建key-value表存储在内存或硬盘，或者是用redis</p>
<p><img src="https://s2.loli.net/2022/05/04/PxhtBiqX7AenEkU.png" alt="image-20220503163840118"></p>
<p>​	从上面可以看出，count(1)和count(*)是没有取值的过程，所以小</p>
<h2 id="7-update优化（避免行锁升级为表锁）"><a href="#7-update优化（避免行锁升级为表锁）" class="headerlink" title="7.update优化（避免行锁升级为表锁）"></a>7.update优化（避免行锁升级为表锁）</h2><p>InnoDB 的<code>行锁是针对索引加的锁</code>，不是针对记录加的锁，并且该索引不能失效，否则会从行锁升级为表锁。</p>
<p>如以下两条语句：<br><code>update student set no = &#39;123&#39; where id = 1;</code>，这句由于id有主键索引，所以只会锁这一行；<br><code>update student set no = &#39;123&#39; where name = &#39;test&#39;;</code>，这句由于name没有索引，所以会把整张表都锁住进行数据更新，解决方法是给name字段添加索引</p>
<h1 id="五、视图-x2F-存储过程-x2F-触发器"><a href="#五、视图-x2F-存储过程-x2F-触发器" class="headerlink" title="五、视图&#x2F;存储过程&#x2F;触发器"></a>五、视图&#x2F;存储过程&#x2F;触发器</h1><p><img src="https://s2.loli.net/2022/05/06/VwHtZGLrs3XCBof.png" alt="image-20220506163730446"></p>
<h2 id="1-视图"><a href="#1-视图" class="headerlink" title="1. 视图"></a>1. 视图</h2><p>①语法</p>
<p><img src="https://s2.loli.net/2022/05/04/jKNSIomCEZrgUYO.png" alt="image-20220504160140852"></p>
<p>1）with cascaded check option</p>
<p>v1 通过 user基表建立，v2通过v1建立，v3通过v2建立</p>
<p><img src="https://s2.loli.net/2022/05/04/PF2Ilnyv3WgJ158.png" alt="image-20220504161658280"></p>
<p><img src="https://s2.loli.net/2022/05/04/w3E84SoP5DQrZfz.png" alt="image-20220504162025288"></p>
<p>当v2表cascaded后，它在insert数据的时候也会检查其所依赖的v1条件；v3没有cascaded，虽然它依赖了cascaded的v2，但是insert的数据检查也只会检查v1，v2的条件，并不会检查v3</p>
<p>2）with local check option</p>
<p><img src="https://s2.loli.net/2022/05/04/Vt5c6AhszexKqJ4.png" alt="image-20220504162607548"></p>
<p>local就是会递归的去寻找，满足v2后会看v1的option，如果没有则不会管v1的条件</p>
<p>3）相关事项及实例</p>
<p>注意：</p>
<ul>
<li>视图的增删改操作必须是视图中的一条数据对应基表的一条数据，若使用了聚合函数、group by、distinct、having、union(all)等，视图是无法更新的</li>
<li>视图的作用：<ul>
<li>简单：方便用户对数据理解，可以将经常查询的数据定义成一张视图</li>
<li>安全：视图能让用户只浏览和修改到他们被允许的数据（mysql的表权限中不包含columns的权限）</li>
<li>数据独立：屏蔽真实表结构变化带来的影响 name -&gt; stuName</li>
</ul>
</li>
</ul>
<p><img src="https://s2.loli.net/2022/05/04/qWYeCaVbirOBp5U.png" alt="image-20220504164219294"></p>
<p>​	三表联查：</p>
<p>​	<img src="https://s2.loli.net/2022/05/04/6NOkcM4nKSljq2P.png" alt="image-20220504165031609"></p>
<h2 id="2-存储过程"><a href="#2-存储过程" class="headerlink" title="2. 存储过程"></a>2. 存储过程</h2><h3 id="1）变量"><a href="#1）变量" class="headerlink" title="1）变量"></a>1）变量</h3><p>1）系统变量（@@）</p>
<p>​	session：会话变量，在另外一个会话中则不存在，未指定默认是session</p>
<p>​	global：全局变量，在所有会话中都存在，但是在restart mysql后还是不会改变（持久改变需要在配置文件中配置）</p>
<p><img src="https://s2.loli.net/2022/05/04/O56V1xY4XIUQKdC.png" alt="image-20220504205411850"></p>
<p>2）用户自定义变量（@）</p>
<p><img src="https://s2.loli.net/2022/05/04/4TOz2eSnJlQgwMG.png" alt="image-20220504205426856"></p>
<p>3）局部变量</p>
<p>​	只在存储过程中生效</p>
<p><img src="https://s2.loli.net/2022/05/05/PRMQ3GcIDke2JT8.png" alt="image-20220505210448969"></p>
<h3 id="2）存储过程中的语法"><a href="#2）存储过程中的语法" class="headerlink" title="2）存储过程中的语法"></a>2）存储过程中的语法</h3><h4 id="①if"><a href="#①if" class="headerlink" title="①if"></a>①if</h4><p><img src="https://s2.loli.net/2022/05/05/FkjyDKNR7I3vOJp.png" alt="image-20220505154639503"></p>
<p>​	</p>
<h4 id="②case"><a href="#②case" class="headerlink" title="②case"></a>②case</h4><p><img src="https://s2.loli.net/2022/05/05/OWcUtonTPCm1AIz.png" alt="image-20220505154816329"></p>
<p>​	<img src="https://s2.loli.net/2022/05/05/sdyktMcIi34x7Yf.png" alt="image-20220505155327524"></p>
<h4 id="③while"><a href="#③while" class="headerlink" title="③while"></a>③while</h4><p><img src="https://s2.loli.net/2022/05/05/om9e35AVERQkFtp.png" alt="image-20220505164543557"></p>
<h4 id="④repeat"><a href="#④repeat" class="headerlink" title="④repeat"></a>④repeat</h4><p><img src="https://s2.loli.net/2022/05/05/nvBiLafzYgQoTdE.png" alt="image-20220505164840620"></p>
<h4 id="⑤loop"><a href="#⑤loop" class="headerlink" title="⑤loop"></a>⑤loop</h4><p><img src="https://s2.loli.net/2022/05/05/sGodEcNFX4xguPp.png" alt="image-20220505164923239"></p>
<p><img src="https://s2.loli.net/2022/05/05/6iQB9kvRUHuPTaF.png" alt="image-20220505165923716"></p>
<h4 id="⑥cursor-游标"><a href="#⑥cursor-游标" class="headerlink" title="⑥cursor 游标"></a>⑥cursor 游标</h4><p>游标类似于一个集合、迭代器，每次从游标中取一行数据</p>
<p>​	<img src="https://s2.loli.net/2022/05/05/OfSv69jIyRxr2ZU.png" alt="image-20220505172302719"></p>
<p>eg：</p>
<p><img src="https://s2.loli.net/2022/05/05/1YSkTZX36dUajbK.png" alt="image-20220505172434324"></p>
<h4 id="⑦handler-条件处理程序"><a href="#⑦handler-条件处理程序" class="headerlink" title="⑦handler 条件处理程序"></a>⑦handler 条件处理程序</h4><p>类似于异常处理，根据捕获的异常码来处理</p>
<p><img src="https://s2.loli.net/2022/05/05/6sTWjenSC1rkZJK.png" alt="image-20220505211156206"></p>
<p>eg：</p>
<p><img src="https://s2.loli.net/2022/05/05/Q7jpROgLsWVGa8F.png" alt="image-20220505172652900"></p>
<p><img src="https://s2.loli.net/2022/05/05/oVfsBG8Y5zRk9g2.png" alt="image-20220505211219491"></p>
<p>这个对游标的改进就是在，游标抛出异常02000（not found）后关闭cursor</p>
<h3 id="3）存储函数"><a href="#3）存储函数" class="headerlink" title="3）存储函数"></a>3）存储函数</h3><p><img src="https://s2.loli.net/2022/05/05/Kqopg7ycnHTEiJA.png" alt="image-20220505211335765"></p>
<p><img src="https://s2.loli.net/2022/05/05/5tnMHfhJiLPN8zA.png" alt="image-20220505173415696"></p>
<h2 id="3-触发器"><a href="#3-触发器" class="headerlink" title="3. 触发器"></a>3. 触发器</h2><p>触发器可以在insert&#x2F;update&#x2F;delete 语句执行之后，执行触发器中定义的sql，可以完成日志记录、数据校验等工作</p>
<p>触发器目前只支持 <code>行级触发</code>：如一条语句影响了5行数据，那么触发器会被执行5次</p>
<p>​								<code>语句级触发</code>：如一条语句影响了多行数据，但是触发器只会触发一次</p>
<p><img src="https://s2.loli.net/2022/05/05/VZqa8Y4G7PQkyn1.png" alt="image-20220505211434421"></p>
<p>1）语法</p>
<p><img src="https://s2.loli.net/2022/05/06/PKirfo5e8sMUayt.png" alt="image-20220506160024421"></p>
<p>2）案例</p>
<p>eg1：insert案例</p>
<p><img src="https://s2.loli.net/2022/05/06/U28D1M73bECdFNB.png" alt="image-20220506162909736"></p>
<p>eg2：update案例</p>
<p><img src="https://s2.loli.net/2022/05/06/FPUskB4agijIlmc.png" alt="image-20220506162935928"></p>
<p>eg3：delete案例</p>
<p><img src="https://s2.loli.net/2022/05/06/NIjZkwAqCT8ag17.png" alt="image-20220506163012628"></p>
<h1 id="六、锁"><a href="#六、锁" class="headerlink" title="六、锁"></a>六、锁</h1><p><img src="https://s2.loli.net/2022/06/06/q3dHPWGOjCmbiuV.png" alt="image-20220507164328021"></p>
<h2 id="1-全局锁"><a href="#1-全局锁" class="headerlink" title="1. 全局锁"></a>1. 全局锁</h2><h3 id="1）基本概念"><a href="#1）基本概念" class="headerlink" title="1）基本概念"></a>1）基本概念</h3><p>全局锁就是对整个数据库实例加锁，加锁后整个实例就处于只读状态，后续的DML的写语句，DDL语句，已经更新操作的事务提交语句都将被阻塞。其典型的使用场景是做全库的逻辑备份，对所有的表进行锁定，从而获取一致性视图，保证数据的完整性。</p>
<p>全局锁是对整个数据库加锁，加锁后可以查询DQL，但是DDL和DML语句都不能执行，主要用于备份：</p>
<h4 id="①备份不加锁"><a href="#①备份不加锁" class="headerlink" title="①备份不加锁"></a>①备份不加锁</h4><p><img src="https://s2.loli.net/2022/07/21/j9Lu6eoVDGWrx1Y.png" alt="image-20220720150834990"></p>
<p>假设在数据库中存在这样三张表: tb_stock 库存表，tb_order 订单表，tb_orderlog 订单日志表。	</p>
<ul>
<li>在进行数据备份时，先备份了tb_stock库存表。</li>
<li>然后接下来，在业务系统中，执行了下单操作，扣减库存，生成订单（更新tb_stock表，插入tb_order表）。</li>
<li>然后再执行备份 tb_order表的逻辑。</li>
<li>业务中执行插入订单日志操作。</li>
<li>最后，又备份了tb_orderlog表。</li>
</ul>
<p>此时备份出来的数据，是存在问题的。因为备份出来的数据，tb_stock表与tb_order表的数据不一致（有新的订单信息,但是库存数没减)，此时就可以借助于MySQL的全局锁来解决。</p>
<h4 id="②备份加锁"><a href="#②备份加锁" class="headerlink" title="②备份加锁"></a>②备份加锁</h4><img src="https://s2.loli.net/2022/07/21/PhS8i3A7YzEHNxm.png" alt="image-20220720151124120" style="zoom:80%;" />

<p>加了全局锁后的情况：<br>        对数据库进行进行逻辑备份之前，先对整个数据库加上全局锁，一旦加了全局锁之后，其他的DDL、<br>DML全部都处于阻塞状态，但是可以执行DQL语句，也就是处于只读状态，而数据备份就是查询操作。<br>那么数据在进行逻辑备份的过程中，数据库中的数据就是不会发生变化的，这样就保证了数据的一致性<br>和完整性。</p>
<h3 id="2）使用"><a href="#2）使用" class="headerlink" title="2）使用"></a>2）使用</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加全局锁</span></span><br><span class="line">flush tables with <span class="built_in">read</span> lock ;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 数据备份 这并不是mysql的命令，而是mysql提供的一个工具</span></span><br><span class="line"><span class="comment"># xxx代表被封的dataBase名，yyy代表备份的地址，备份文件一般以.sql结尾</span></span><br><span class="line">mysqldump -uroot –p1234 xxx &gt; yyy.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 释放锁</span></span><br><span class="line">unlock tables ;</span><br></pre></td></tr></table></figure>



<h3 id="3）特点"><a href="#3）特点" class="headerlink" title="3）特点"></a>3）特点</h3><p>数据库中加全局锁，是一个比较重的操作，存在以下问题：</p>
<ul>
<li><p>如果在主库上备份，那么在备份期间都不能执行更新，业务基本上就得停摆。</p>
</li>
<li><p>如果在从库上备份，那么在备份期间从库不能执行主库同步过来的二进制日志（binlog），会导致主从延迟。</p>
</li>
</ul>
<p>在InnoDB引擎中，我们可以在备份时加上参数 <code>--single-transaction</code> 参数来完成不加锁的一致性数据备份。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 数据备份 这并不是mysql的命令，而是mysql提供的一个工具</span></span><br><span class="line"><span class="comment"># xxx代表被封的dataBase名，yyy代表备份的地址，备份文件一般以.sql结尾</span></span><br><span class="line">mysqldump --single-transaction -uroot –p123456 xxx &gt; yyy.sqlxxx &gt; itcast.sql</span><br></pre></td></tr></table></figure>



<h2 id="2-表级锁"><a href="#2-表级锁" class="headerlink" title="2. 表级锁"></a>2. 表级锁</h2><h3 id="1）表锁"><a href="#1）表锁" class="headerlink" title="1）表锁"></a>1）表锁</h3><p><img src="D:\Typora\TyporaPictureBed\image-20220810140251418.png" alt="image-20220810140251418"></p>
<ul>
<li><p>读锁（表共享读锁）：读锁本会话可读不可写，其他会话也是可读不可写（阻塞其它客户端的写）</p>
</li>
<li><p>写锁（表独占写锁）：写锁本会话可读可写，其他会话不可读不可写（会被阻塞，释放锁以后会继续执行）</p>
</li>
</ul>
<h3 id="2）元数据锁"><a href="#2）元数据锁" class="headerlink" title="2）元数据锁"></a>2）元数据锁</h3><ul>
<li><p>MDL加锁过程是系统自动控制，无需显式使用，在访问一张表的时候会自动加上</p>
</li>
<li><p>MDL锁主要作用是<strong>维护表元数据的数据一致性（表结构），在表上有活动事务的时候，不可以对元数据进行写入操作</strong></p>
<ul>
<li>在My5QL5.5中引入了MDL，当对一张表进行增删改查的时候，加MDL读锁(共享)</li>
<li>当对表结构进行变更操作的时候，加MDL写锁(排他)</li>
</ul>
</li>
</ul>
<p><img src="https://s2.loli.net/2022/05/09/xofWdeGj46PXapn.png" alt="image-20220507110905936"></p>
<p>事务A在做select查询并且事务没结束，那么这时候通过alter改变表结构（元数据）是不被允许的</p>
<h3 id="3）意向锁"><a href="#3）意向锁" class="headerlink" title="3）意向锁"></a>3）意向锁</h3><p>意向锁的作用，一个例子：</p>
<p><img src="https://s2.loli.net/2022/05/09/Auf65IJFRTaBkV2.png" alt="image-20220507151137396"></p>
<p>​	当线程A中的事务中执行update语句的时候（根据id索引）会锁住这一行的数据，如果此时有另外一个线程要为该表加read&#x2F;write lock，那么这个线程有需要一条一条的检查看是否有行锁，这样效率太低了</p>
<p>​	为解决这一问题，在事务中执行sql语句的时候，mysql除了添加行锁，还会为整张表添加一个意向锁，当其他线程要为该表加锁的时候，就可以根据所加的意向锁判断是否能加锁，而不需要一条一条检查数据</p>
<p><img src="https://s2.loli.net/2022/05/09/WNq4xmK3uFQkyEJ.png" alt="image-20220507151525142"></p>
<ul>
<li><p>select …. lock in share mode 会添加意向共享锁，可以与表共享读锁（read）兼容，与表独占写锁（write）互斥（会发生阻塞）</p>
</li>
<li><p>增删改、查询for update 会添加意向排他锁，与read和write都互斥</p>
</li>
<li><p>意向锁直接都是兼容的，意向共享锁和read锁兼容和write锁互斥，意向排他锁与read锁和write都互锁</p>
</li>
</ul>
<h2 id="3-行级锁"><a href="#3-行级锁" class="headerlink" title="3. 行级锁"></a>3. 行级锁</h2><p><img src="https://s2.loli.net/2022/05/09/1jurzLWNCq38GgR.png" alt="image-20220507164656196"></p>
<h3 id="1）行锁"><a href="#1）行锁" class="headerlink" title="1）行锁"></a>1）行锁</h3><p>行锁有两种：s（共享锁）、x（排他锁）</p>
<p><img src="https://s2.loli.net/2022/05/09/elfca7NMZozb5Bs.png" alt="image-20220507161617768"></p>
<p><img src="https://s2.loli.net/2022/05/09/K8Pkat2cEFLAWrj.png" alt="image-20220507161648455"></p>
<p>总结：</p>
<ul>
<li>增删改操作都是加排他锁</li>
<li>普通select不加锁</li>
<li>select语句后加lock in share mode 共享锁，加for update 加排他锁</li>
</ul>
<p>注意：</p>
<ul>
<li>mysql的行级锁是针对索引的锁，锁住的是聚集索引叶子结点的一个数据，若在增删改的时候没有用到索引，那么行锁就会升级成为表锁</li>
<li>查询元数据锁和行锁的语句<ul>
<li>select object_schema,object_name,index_name,lock_type,lock_mode,lock_data from<br>performance_schema.data_locks;</li>
</ul>
</li>
</ul>
<p><img src="https://s2.loli.net/2022/05/09/UORIs8H4YrPA6V5.png" alt="image-20220507163229143"></p>
<p><img src="https://s2.loli.net/2022/05/09/STAePBOwDfnj7cJ.png" alt="image-20220507163251643"></p>
<h3 id="2）间隙锁、临键锁"><a href="#2）间隙锁、临键锁" class="headerlink" title="2）间隙锁、临键锁"></a>2）间隙锁、临键锁</h3><p><img src="https://s2.loli.net/2022/05/09/3Y2QDaPhfWiwut7.png" alt="image-20220507164737508"></p>
<p>默认情况下，使用的是next-key临键锁来进行搜索和索引扫描，当某些情况下临键锁可以优化成间隙锁：</p>
<h4 id="①如当事务A用主键搜寻不存在的数据的时候："><a href="#①如当事务A用主键搜寻不存在的数据的时候：" class="headerlink" title="①如当事务A用主键搜寻不存在的数据的时候："></a>①如当事务A用主键搜寻不存在的数据的时候：</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">update</span> <span class="keyword">user</span> <span class="keyword">set</span> name <span class="operator">=</span> <span class="string">&#x27;ykk&#x27;</span> <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">4</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/05/09/sZq8wyVMIe5RbNj.png" alt="image-20220507165107119"></p>
<p>此时A事务未提交，事务B开启：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span> (id, username, <span class="keyword">no</span>) <span class="keyword">value</span> (<span class="number">4</span>,<span class="string">&#x27;ydd&#x27;</span>,<span class="number">200100105</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">commit</span>; #无法提交，卡主，需要等事务A解开间隙锁才行</span><br></pre></td></tr></table></figure>

<p>事务A我们想update一条id&#x3D;4的数据，第一次查询id&#x3D;4发现没有数据，这时候临键锁优化为间隙锁，将3与5的间隙锁起来（B+树结构中，这两个row是相邻的），那么事务B就不能在3和5间插入id&#x3D;4的事务，那么事务A在插入id&#x3D;4的数据的时候就不会出现幻读的现象</p>
<h4 id="②因为是非唯一索引，所以会出现重复值"><a href="#②因为是非唯一索引，所以会出现重复值" class="headerlink" title="②因为是非唯一索引，所以会出现重复值"></a>②因为是非唯一索引，所以会出现重复值</h4><p><img src="https://s2.loli.net/2022/08/10/sdjK29g4r8hlkTD.png" alt="image-20220810150310958"></p>
<p>由于是非唯一，为了防止其它事务在15之间的间隙插入数据造成幻读，那么需要将间隙和值都锁上，一直到最后一个不匹配的row</p>
<h4 id="③范围查询锁到不满足要求为止"><a href="#③范围查询锁到不满足要求为止" class="headerlink" title="③范围查询锁到不满足要求为止"></a>③范围查询锁到不满足要求为止</h4><p>如select * from user where id&gt;&#x3D;19，那么锁就会从19的row开始一直锁到正无穷大，其中的键和间隙都会被锁住</p>
<h1 id="七、InnoDB引擎"><a href="#七、InnoDB引擎" class="headerlink" title="七、InnoDB引擎"></a>七、InnoDB引擎</h1><h2 id="1-架构图"><a href="#1-架构图" class="headerlink" title="1. 架构图"></a>1. 架构图</h2><h3 id="1）逻辑结构"><a href="#1）逻辑结构" class="headerlink" title="1）逻辑结构"></a>1）逻辑结构</h3><p><img src="https://s2.loli.net/2022/07/21/Zz9ab24JAr8dVH6.png" alt="image-20220719213835138"></p>
<p><strong>①表空间</strong></p>
<p>表空间是InnoDB存储引擎逻辑结构的最高层， 如果用户启用了参数 innodb_file_per_table(在<br>8.0版本中默认开启) ，则每张表都会有一个表空间（xxx.ibd），一个mysql实例可以对应多个表空<br>间，用于存储记录、索引等数据。</p>
<p><strong>②段</strong></p>
<p>段，分为数据段（Leaf node segment）、索引段（Non-leaf node segment）、回滚段<br>（Rollback segment），InnoDB是索引组织表，数据段就是B+树的叶子节点， 索引段即为B+树的<br>非叶子节点。段用来管理多个Extent（区）。</p>
<p><strong>③区</strong></p>
<p>区，表空间的单元结构，每个区的大小为1M。 默认情况下， InnoDB存储引擎页大小为16K， 即一<br>个区中一共有 64 个连续的页。</p>
<p><strong>④页</strong></p>
<p>页，是InnoDB 存储引擎磁盘管理的最小单元，每个页的大小默认为 16KB。为了保证页的连续性，<br>InnoDB 存储引擎每次从磁盘申请 4-5 个区。</p>
<p><strong>⑤行</strong></p>
<p>行，InnoDB 存储引擎数据是按行进行存放的。</p>
<p>在行中，默认有两个隐藏字段：</p>
<ul>
<li>Trx_id：每次对某条记录进行改动时，都会把对应的事务id赋值给trx_id隐藏列。</li>
<li>Roll_pointer：每次对某条引记录进行改动时，都会把旧的版本写入到undo日志中，然后这个隐藏列就相当于一个指针，可以通过它来找到该记录修改前的信息</li>
</ul>
<h3 id="2）物理结构"><a href="#2）物理结构" class="headerlink" title="2）物理结构"></a>2）物理结构</h3><img src="https://s2.loli.net/2022/07/21/L71U5qov6S9tWiG.png" alt="image-20220719214304358" style="zoom:80%;" />



<h2 id="2-事务原理"><a href="#2-事务原理" class="headerlink" title="2. 事务原理"></a>2. 事务原理</h2><p><img src="https://s2.loli.net/2022/07/21/jxo8dW4E9SOysR5.png" alt="image-20220719214616959"></p>
<p><img src="https://s2.loli.net/2022/07/21/85OGm1gbYc6hKCd.png" alt="image-20220719214719762"></p>
<p>​	MVCC（无锁）+锁保证了事务的隔离性，redo log 保证了事务的持久性，undo log 保证了事务的原子性，redo log 和 undo log 一起保证了事务的一致性。</p>
<h3 id="1）redo-log"><a href="#1）redo-log" class="headerlink" title="1）redo log"></a>1）redo log</h3><p>​	redo log保证了事务的<code>持久性</code></p>
<p><img src="https://s2.loli.net/2022/07/21/d4oGYh6kLnMiXzW.png" alt="image-20220719220341968"></p>
<p>问题情境：</p>
<p>​	InnoDB内存结构中，主要的内存区就是缓冲池，缓冲池中缓冲了很多的数据页。当我们在一个事务中执行增删改操作的时候，InnoDB会直接操作缓冲池中的数据，将缓冲池中的数据修改，如果缓冲池中没有对应的页，那么就会通过后台线程调入对应需要操作的数据。在缓冲区中被修改过的数据页称为脏页，脏页会在一定的时机，通过后台线程刷新到磁盘中，从而保证缓冲区中数据和磁盘中的数据一致。因此缓冲区的脏页数据并不是实时刷新的，若过一段时间后在从缓冲区向磁盘刷新数据的过程中出错了，但提示给用户事务提交成功，但是数据却没持久化下来。</p>
<p>解决办法redo log：</p>
<p>​	有了redo log 后，在对缓冲区的数据进行增删改操作后，会首先将数据页的变化记录在redo log buffer中，在事务提交时会将redo log buffer中的数据刷新到redo log磁盘文件中。如果脏页数据出错，此时就可以借助于redo log来进行数据恢复，以此来保护数据持久性。若 脏页数据已经成功刷新到磁盘 或 涉及到的数据已经落盘，那么redo log就没用了，可以删除了，所以存在的两个redo log文件是循环写的（一个没用了删掉用另一个）</p>
<p>总结：</p>
<ul>
<li>redo log 有两部分<ul>
<li>内存：redo log buffer 在事务提交后马上刷新给磁盘中的redo log</li>
<li>磁盘：两个redo log 循环写</li>
</ul>
</li>
<li>为什么不能直接将脏页数据实时刷新，而是刷新redo log buffer中的数据？<ul>
<li>因为操作的数据页地址是随机的，如果实时刷新脏数据，那么就是随机IO（随机读写磁盘），性能低</li>
<li>redo log的刷新是顺序IO（日志按顺序写的），数据效率高</li>
<li>这种机制叫<strong>WAL(Write-Ahead-Logging)</strong></li>
</ul>
</li>
<li>redo log其实就是为了脏页刷新发生错误的时候进行数据恢复</li>
</ul>
<h3 id="2）undo-log"><a href="#2）undo-log" class="headerlink" title="2）undo log"></a>2）undo log</h3><p>​	undo log 保证了事务的<code>原子性</code></p>
<p>​	undo log 主要是为了 <code>回滚事务</code> 和 <code>MVCC</code>，不同于redo log 是物理日志，undo log 是逻辑日志：</p>
<p>​	当在事务中执行了一条insert语句后，undo log就会记录一条相反逻辑的delete语句，执行一条update语句后，undo log就会记录一条相反逻辑的update语句</p>
<ul>
<li><p>undo log 的销毁：</p>
<ul>
<li>在执行完事务后（commit 或 rollback后），并不会马上删除，因为MVCC还可能用到undo log</li>
</ul>
</li>
<li><p>undo log 的存储：undo log 通过段segment的方式存储，（segments：数据段—B+树叶子节点，索引段—非叶子节点，回滚段—undo log）</p>
<ul>
<li>段，分为数据段（Leaf node segment）、索引段（Non-leaf node segment）、回滚段<br>（Rollback segment），InnoDB是索引组织表，数据段就是B+树的叶子节点， 索引段即为B+树的<br>非叶子节点。段用来管理多个Extent（区）</li>
</ul>
</li>
<li><p>两个作用：</p>
<ul>
<li>回滚：回滚是在事务结束的时候（commit或rollback），如果选择回滚，那么mysql会执行undo log中的逻辑记录</li>
<li>MVCC：undo log 中记录了版本链，版本链配合readview来完成MVCC版本控制</li>
</ul>
</li>
</ul>
<h3 id="3）MVCC"><a href="#3）MVCC" class="headerlink" title="3）MVCC"></a>3）MVCC</h3><img src="https://s2.loli.net/2022/08/10/YFgkevKsO7opDPd.png" alt="image-20220810152740685" style="zoom:80%;" />

<p>MVCC的实现原理就是通过InnoDB表的隐藏字段、UndoLog 版本链、Readview来实现的。而MVCC＋锁，则实现了事务的隔离性。而一致性则是由redolog 与undolog保证。</p>
<p>MVCC是在快照读的时候通过<code>事务id</code>，<code>undo log 版本链</code>，<code>ReadView</code>来查找返回的历史版本数据。</p>
<p>MVCC就是通过表中的隐藏字段<code>事务id</code>，<code>undo log 版本链</code>，<code>ReadView</code>（事务确定）三者来实现的：</p>
<p>查询的时候会根据<code>当前的事务活动情况</code>和<code>事务id</code>来确定<code>ReadView</code>，然后再从<code>undo log版本链</code>头部开始通过查看<code>事务id</code>是否满足<code>ReadView</code>的匹配条件，满足条件则返回该版本</p>
<h4 id="①当前读和快照读"><a href="#①当前读和快照读" class="headerlink" title="①当前读和快照读"></a>①当前读和快照读</h4><h5 id="a）当前读"><a href="#a）当前读" class="headerlink" title="a）当前读"></a>a）当前读</h5><p>读取的是记录的最新版本，读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。</p>
<p>对于我们日常的操作如: </p>
<ul>
<li>select … lock in share mode (共享锁)</li>
<li>select …for update、update、insert、delete(排他锁)都是一种当前读。</li>
</ul>
<p>当前读读取的是记录的最新版本，读取的需要保证其他并发事务，所以会对读取的数据加锁</p>
<p>eg：</p>
<p><img src="https://s2.loli.net/2022/05/09/pebuDKW48JadAIx.png" alt="image-20220509161941938"></p>
<p>​	当A事务开启后，①的查询结果id&#x3D;2是PHP，此时开启B事务并执行修改id&#x3D;2为JSP数据操作，再次通过事务A的①查，查不出该次变化，因为当前隔离级别是可重复读，保证了两次读取事务的一致性；如果读取到当前事务的最新数据，可以使用②select …. lock in share mode 来进行当前读，这样读取到的就是最新的数据id&#x3D;2是JSP。</p>
<h5 id="b）快照读"><a href="#b）快照读" class="headerlink" title="b）快照读"></a>b）快照读</h5><p>简单的select(不加锁)就是快照读，快照读，读取的是记录数据的可见版本，有可能是历史数据，不加锁，是非阻塞读。</p>
<ul>
<li><p>Read Committed：每次select，都生成一个快照读。</p>
</li>
<li><p>Repeatable Read：开启事务后第一个select语句才是快照读的地方。</p>
</li>
<li><p>serializable：快照读会退化为当前读。</p>
</li>
</ul>
<p>​	快照读是根据一定规则MVCC读取记录数据的可见版本，有可能是历史数据，这个过程是不加锁的</p>
<pre><code>* 读已提交：每次的select都是一个快照读
* 可重复读：开启事务后的第一个select是快照读，后续的select只是直接使用第一个快照读的数据（查询的实际上是第一个快照数据）
* 串行化：快照读退化成当前读
</code></pre>
<h4 id="②隐藏字段"><a href="#②隐藏字段" class="headerlink" title="②隐藏字段"></a>②隐藏字段</h4><p><img src="https://s2.loli.net/2022/05/09/K2E1FBPGgZdwhQ3.png" alt="image-20220509162454905"></p>
<p>​	每一张表都会有两个隐藏字段：最近事务id、回滚指针，如果该表结构未指定主键，那么会生成隐藏字段row_id。</p>
<h4 id="③undo-log"><a href="#③undo-log" class="headerlink" title="③undo log"></a>③undo log</h4><p>undo log 是回滚日志，在insert、update、delete的时候会产生回滚数据来产生：</p>
<ul>
<li><p>当insert的时候，数据只需要回滚的时候使用，所以commit后（证明没有rollback）可以直接删除</p>
</li>
<li><p>update、delete，数据不仅在回滚的时候需要使用，在快照读的时候也需要，所以不能删除</p>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1Kr4y1i7ru?p=143&amp;spm_id_from=pageDriver">https://www.bilibili.com/video/BV1Kr4y1i7ru?p=143&amp;spm_id_from=pageDriver</a></p>
<p>undo log 版本链：</p>
<p><img src="https://s2.loli.net/2022/05/09/O1EnUrXhtJMRKDP.png" alt="image-20220509163719909"></p>
<ul>
<li>每当要修改一条记录的时候，就会在undo log存储该版本（包括事务id，回滚指针指向上个版本），最新记录的回滚指针指向该版本</li>
<li>版本之间通过回滚指针连接，头部是最新记录，尾部是最旧记录</li>
</ul>
<h4 id="④readview-读视图）"><a href="#④readview-读视图）" class="headerlink" title="④readview(读视图）"></a>④readview(读视图）</h4><p>readview是每个事务独有的，主要内容有两部分：有四个字段、定义了 <code>快照读sql</code>访问版本链的规则</p>
<h5 id="a）字段"><a href="#a）字段" class="headerlink" title="a）字段"></a>a）字段</h5><p><img src="https://s2.loli.net/2022/05/09/dPaH7NSteDTi8hI.png" alt="image-20220509164846607"></p>
<p>注意max_trx_id 并不是目前最大id，而是最大事务id+1（下一个分配的id）</p>
<h5 id="b）定义的访问undo-log-版本链的规则"><a href="#b）定义的访问undo-log-版本链的规则" class="headerlink" title="b）定义的访问undo log 版本链的规则"></a>b）定义的访问undo log 版本链的规则</h5><p><img src="https://s2.loli.net/2022/05/09/85TpM4tfOrSyZAE.png" alt="image-20220509165041625"></p>
<p>trx_id 代表的当前版本链中隐藏字段中的 <code>事务id</code></p>
<p>注意：不同的隔离级别，会在不同的时机生成readview来进行快照读</p>
<ul>
<li><p>读已提交</p>
<ul>
<li>会在每次select时都生成一个readview来作为此次快照读的依据（读已提交每次select都是一个快照读）</li>
</ul>
</li>
<li><p>可重复读</p>
<ul>
<li>会在第一次select时生成一个readview来作为本次快照读的依据（可重复读只有第一次select是快照读，后序select都是复用该次数据）</li>
</ul>
</li>
</ul>
<h4 id="⑤RC和RR的MVCC"><a href="#⑤RC和RR的MVCC" class="headerlink" title="⑤RC和RR的MVCC"></a>⑤RC和RR的MVCC</h4><h5 id="a）RC-隔离级别"><a href="#a）RC-隔离级别" class="headerlink" title="a）RC 隔离级别"></a>a）RC 隔离级别</h5><p><img src="D:/Typora/TyporaPictureBed/image-20220509170102112.png" alt="image-20220509170102112"></p>
<p>PC的每次select都是一个快照读，所以事务5的两次select会有两个ReadView</p>
<p><img src="https://s2.loli.net/2022/05/09/EeXWmpy6u9o4qMV.png" alt="image-20220509170537409"></p>
<p>​	MVCC就是在快照读的时候，根据该次select产生的readView，将undo log 的版本链中从头开始 通过每条数据中隐藏字段中的<code>事务id</code>与readView指定的规则做匹配，如果匹配了则返回该条版本记录。</p>
<h5 id="b）RR-隔离级别"><a href="#b）RR-隔离级别" class="headerlink" title="b）RR 隔离级别"></a>b）RR 隔离级别</h5><p><img src="https://s2.loli.net/2022/05/09/6bDL1dOAgfG9ev4.png" alt="image-20220509202827554"></p>
<p>​	在RR隔离级别下，只有在第一个select快照读的时候会生成ReadView，后序的select都是复用该ReadView，所以可以保证多次select的数据是一致的。</p>
<h1 id="八、高可用"><a href="#八、高可用" class="headerlink" title="八、高可用"></a>八、高可用</h1><h2 id="1-日志"><a href="#1-日志" class="headerlink" title="1.日志"></a>1.日志</h2><h3 id="1）错误日志"><a href="#1）错误日志" class="headerlink" title="1）错误日志"></a>1）错误日志</h3><p>错误日志是 MySQL 中最重要的日志之一，它记录了当 mysqld 启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。当数据库出现任何故障导致无法正常使用时，建议首先查看此日志。</p>
<p>该日志是默认开启的，默认存放目录 &#x2F;var&#x2F;log&#x2F;，默认的日志文件名为 mysqld.log 。查看日志位置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like <span class="string">&#x27;%log_error%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<img src="https://s2.loli.net/2022/07/21/FxHmCiQjO5UPM6p.png" alt="image-20220719221959796"  />



<h3 id="2）二进制日志"><a href="#2）二进制日志" class="headerlink" title="2）二进制日志"></a>2）二进制日志</h3><h4 id="①基本概念"><a href="#①基本概念" class="headerlink" title="①基本概念"></a>①基本概念</h4><p>二进制日志（BINLOG）记录了所有的 DDL（数据定义语言）语句和 DML（数据操纵语言）语句，但不包括DQL数据查询（SELECT、SHOW）语句。</p>
<p>作用：①灾难时的数据恢复		②MySQL的主从复制</p>
<p>在MySQL8版本中，默认二进制日志是开启着的，涉及到的参数如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like <span class="string">&#x27;%log_bin%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/07/21/AsjEXfJRNBtFC65.png" alt="image-20220719223119873"></p>
<p><img src="https://s2.loli.net/2022/07/21/2jIA6xJwK7vhDVn.png" alt="image-20220719222706504"></p>
<p>参数说明：</p>
<ul>
<li><p>og_bin_basename：当前数据库服务器的binlog日志的基础名称(前缀)，具体的binlog文件名需要再该basename的基础上加上编号(编号从 000001 开始)。</p>
</li>
<li><p>log_bin_index：binlog的索引文件，里面记录了当前服务器关联的binlog文件有哪些。</p>
</li>
<li><p>因为主要是为了恢复数据，所以记录的都是DDL和DML，DQL都是查询，和恢复数据没关系。</p>
</li>
</ul>
<h4 id="②binlog格式"><a href="#②binlog格式" class="headerlink" title="②binlog格式"></a>②binlog格式</h4><p>MySQL服务器中提供了多种格式来记录二进制日志，具体格式及特点如下：</p>
<table>
<thead>
<tr>
<th>日志格式</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>STATEMENT</td>
<td>基于SQL语句的日志记录，记录的是SQL语句，对数据进行修改的SQL都会记录在日志文件中。</td>
</tr>
<tr>
<td>ROW</td>
<td>基于行的日志记录，记录的是每一行的数据变更。（默认）</td>
</tr>
<tr>
<td>MIXED</td>
<td>混合了STATEMENT和ROW两种格式，默认采用STATEMENT，在某些特殊情况下会自动切换为ROW进行记录。</td>
</tr>
</tbody></table>
<ul>
<li>statement就是记录一条条sql语句，也就是DDL和DML</li>
<li>row记录的是每一行的变更，如一条update语句影响了5行数据，那么row模式就会记录这5行的数据变更</li>
</ul>
<p>查看当前mysql的binlog格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like <span class="string">&#x27;%binlog_format%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/07/21/9qgis8NL1R3BWOy.png" alt="image-20220720141727166"></p>
<p>如果我们需要配置二进制日志的格式，只需要在 &#x2F;etc&#x2F;my.cnf 中配置 binlog_format 参数即可</p>
<h4 id="③binlog的查看"><a href="#③binlog的查看" class="headerlink" title="③binlog的查看"></a>③binlog的查看</h4><p>由于日志是以二进制方式存储的，不能直接读取，需要通过二进制日志查询工具 mysqlbinlog 来查看，具体语法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog [ 参数选项 ] logfilename</span><br><span class="line"></span><br><span class="line">参数选项：</span><br><span class="line">-d 指定数据库名称，只列出指定的数据库相关操作。</span><br><span class="line">-o 忽略掉日志中的前n行命令。</span><br><span class="line">-v 将行事件(数据变更)重构为SQL语句</span><br><span class="line">-vv 将行事件(数据变更)重构为SQL语句，并输出注释信息，注意是v v</span><br></pre></td></tr></table></figure>

<p>由于默认是row记录的，不方便查看，可以先转换成SQL语句的格式</p>
<h4 id="④binlog的删除"><a href="#④binlog的删除" class="headerlink" title="④binlog的删除"></a>④binlog的删除</h4><p>对于比较繁忙的业务系统，每天生成的binlog数据巨大，如果长时间不清除，将会占用大量磁盘空间。可以通过以下几种方式清理日志：</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>reset master</td>
<td>删除全部 binlog 日志，删除之后，日志编号，将从 binlog.000001重新开始</td>
</tr>
<tr>
<td>purge master logs to ‘binlog.*’</td>
<td>删除 * 编号之前的所有日志</td>
</tr>
<tr>
<td>purge master logs before ‘yyyy-mm-dd hh24:mi:ss’</td>
<td>删除日志为 “yyyy-mm-dd hh24:mi:ss” 之前产生的所有日志</td>
</tr>
</tbody></table>
<p>也可以在mysql的配置文件中配置二进制日志的过期时间，设置了之后，二进制日志过期会自动删除。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like <span class="string">&#x27;%binlog_expire_logs_seconds%&#x27;</span>; <span class="comment">#默认是30天</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/07/21/jP9LnsSoGIafyVp.png" alt="image-20220720142657536"></p>
<h3 id="3）查询日志"><a href="#3）查询日志" class="headerlink" title="3）查询日志"></a>3）查询日志</h3><p>询日志中记录了客户端的<strong>所有操作语句</strong>，而二进制日志不包含查询数据的SQL语句。因为记录了所有的操作语句，所以查询日志会非常大，所以查询日志默认情况下是未开启的。</p>
<p>查询日志的开启状态和存放地址：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like <span class="string">&#x27;%general%&#x27;</span>; <span class="comment">#默认是30天</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/07/21/nAjQq5YU2EdLrsN.png" alt="image-20220720143706198"></p>
<p>如果需要开启查询日志，可以修改MySQL的配置文件 &#x2F;etc&#x2F;my.cnf 文件，添加如下内容：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 该选项用来开启查询日志 可选值：0(代表关闭) 或者 1(代表开启) </span></span><br><span class="line"><span class="attr">general_log</span>= <span class="string">1</span></span><br><span class="line"><span class="comment"># 设置日志的文件名 ， 如果没有指定， 默认的文件名为 host_name.log</span></span><br><span class="line"><span class="attr">general_log_file</span>=<span class="string">mysql_query.log</span></span><br></pre></td></tr></table></figure>

<p>开启了查询日志之后，在MySQL的数据存放目录，也就是 &#x2F;var&#x2F;lib&#x2F;mysql&#x2F; 目录下就会出现mysql_query.log 文件。之后所有的客户端的增删改查操作都会记录在该日志文件之中，长时间运行后，该日志文件将会非常大。</p>
<h3 id="4）慢查询日志"><a href="#4）慢查询日志" class="headerlink" title="4）慢查询日志"></a>4）慢查询日志</h3><p>慢查询日志记录了所有执行时间超过参数<strong>long_query_time</strong>设置值并且扫描记录数不小<strong>于min_examined_row_limit</strong>的所有的SQL语句的日志，默认未开启。<strong>long_query_time</strong>默认为10 秒，最小为 0 ， 精度可以到微秒。</p>
<p>如果需要开启慢查询日志，需要在MySQL的配置文件 &#x2F;etc&#x2F;my.cnf 中配置如下参数：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启慢查询日志</span></span><br><span class="line"><span class="attr">slow_query_log</span>= <span class="string">1</span></span><br><span class="line"><span class="comment"># 执行时间参数</span></span><br><span class="line"><span class="attr">long_query_time</span>= <span class="string">2</span></span><br></pre></td></tr></table></figure>

<p>默认情况下，不会记录管理语句，也不会记录不使用索引进行查找的查询。可以使用<strong>log_slow_admin_statements</strong>和更改此行为 <strong>log_queries_not_using_indexes</strong>，入下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 记录执行较慢的管理语句</span></span><br><span class="line"><span class="attr">log_slow_admin_statements</span> = <span class="string">1</span></span><br><span class="line"><span class="comment"># 记录执行较慢的未使用索引的语句</span></span><br><span class="line"><span class="attr">log_queries_not_using_indexes</span> = <span class="string">1</span></span><br></pre></td></tr></table></figure>



<h2 id="2-主从复制"><a href="#2-主从复制" class="headerlink" title="2.主从复制"></a>2.主从复制</h2><h3 id="1）基本概念-1"><a href="#1）基本概念-1" class="headerlink" title="1）基本概念"></a>1）基本概念</h3><ul>
<li><p>主从复制是指将主数据库的 DDL 和 DML 操作通过二进制日志binlog传到从库服务器中，然后在从库上对这些日志重新执行（也叫重做），从而使得从库和主库的数据保持同步。</p>
</li>
<li><p>MySQL支持一台主库同时向多台从库进行复制， 从库同时也可以作为其他从服务器的主库，实现链状复制</p>
<ul>
<li>主库A有从库B，从库B通过主库A的binlog同步，从库B也可以作为从库C的主库，从库C同步的是从库B的数据</li>
</ul>
</li>
<li><p>MySQL 复制的优点主要包含以下三个方面：</p>
<ul>
<li><p>主库出现问题，可以快速切换到从库提供服务。</p>
</li>
<li><p>实现读写分离，降低主库的访问压力。</p>
</li>
<li><p>可以在从库中执行备份，以避免备份期间影响主库服务。</p>
<ul>
<li>从库本来就是只接受查询，所以加上全局锁后进行磁盘备份也不会影响查询的请求</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="2）原理"><a href="#2）原理" class="headerlink" title="2）原理"></a>2）原理</h3><img src="https://s2.loli.net/2022/07/21/ot1lLZE6FBVHGjW.png" alt="image-20220720160842673" style="zoom:80%;" />

<p>MySQL主从复制的核心就是 二进制日志，具体的过程如下：</p>
<ol>
<li>Master 主库在事务提交时，会把数据变更记录在二进制<strong>日志文件 Binlog</strong> 中。</li>
<li>IO线程读：从库的取主库的二进制日志文件 Binlog ，写入到从库的<strong>中继日志 Relay Log</strong> 。</li>
<li>SQL线程：slave重做中继日志中的事件，复制完成。</li>
</ol>
<h3 id="3）搭建"><a href="#3）搭建" class="headerlink" title="3）搭建"></a>3）搭建</h3><h4 id="①基本组成"><a href="#①基本组成" class="headerlink" title="①基本组成"></a>①基本组成</h4><img src="https://s2.loli.net/2022/07/21/GIWvJRsie52UDM9.png" alt="image-20220720161115019" style="zoom:80%;" />

<ul>
<li>需要暴露对应的端口，或者直接关闭防火墙</li>
</ul>
<h4 id="②主库"><a href="#②主库" class="headerlink" title="②主库"></a>②主库</h4><ol>
<li>修改配置文件 &#x2F;etc&#x2F;my.cnf</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql 服务ID，保证整个集群环境中唯一，取值范围：1 – 232-1，默认为 1</span></span><br><span class="line"><span class="attr">server-id</span>= <span class="string">1</span></span><br><span class="line"><span class="comment"># 是否只读,1 代表只读, 0 代表读写</span></span><br><span class="line"><span class="attr">read-only</span>= <span class="string">0</span></span><br><span class="line"><span class="comment"># 忽略的数据, 指不需要同步的数据库</span></span><br><span class="line"><span class="comment"># binlog-ignore-db=mysql</span></span><br><span class="line"><span class="comment"># 指定同步的数据库</span></span><br><span class="line"><span class="comment"># binlog-do-db=db</span></span><br></pre></td></tr></table></figure>



<ol start="2">
<li>重启MySQL服务器</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>登录mysql，创建远程连接的账号，并授予主从复制权限</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建itcast用户，并设置密码，该用户可在任意主机连接该MySQL服务</span></span><br><span class="line">CREATE USER <span class="string">&#x27;itcast&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;Root@123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#为 &#x27;itcast&#x27;@&#x27;%&#x27; 用户分配主从复制权限</span></span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO <span class="string">&#x27;itcast&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>



<ol start="4">
<li>通过指令，查看二进制日志坐标</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/07/21/C4jcu8WKbH7AXR3.png" alt="image-20220720161545190"></p>
<p>字段含义说明：</p>
<ul>
<li>file: 从哪个日志文件开始推送日志文件</li>
<li>position： 从哪个位置开始推送日志，即开始同步的位置</li>
<li>binlog_ignore_db: 指定不需要同步的数据库</li>
</ul>
<h4 id="②从库"><a href="#②从库" class="headerlink" title="②从库"></a>②从库</h4><ol>
<li>修改配置文件 &#x2F;etc&#x2F;my.cnf</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql 服务ID，保证整个集群环境中唯一，取值范围：1 – 2^32-1，和主库不一样即可</span></span><br><span class="line">server-id= 2</span><br><span class="line"><span class="comment"># 是否只读,1 代表只读, 0 代表读写</span></span><br><span class="line">read-only= 1</span><br></pre></td></tr></table></figure>

<ul>
<li>尽管从库设置的是只读，但是super用户还是有权限来进行写操作，可以通过以下命令关闭<ul>
<li><code>super-read-only=1</code>，设置超级管理员也只能进行读操作</li>
</ul>
</li>
</ul>
<ol start="2">
<li>重新启动MySQL服务</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>登录mysql，设置主库配置</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CHANGE REPLICATION SOURCE TO SOURCE_HOST=<span class="string">&#x27;192.168.200.200&#x27;</span>, SOURCE_USER=<span class="string">&#x27;itcast&#x27;</span>,</span><br><span class="line">SOURCE_PASSWORD=<span class="string">&#x27;Root@123456&#x27;</span>, SOURCE_LOG_FILE=<span class="string">&#x27;binlog.000004&#x27;</span>,</span><br><span class="line">SOURCE_LOG_POS= 663 ;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>参数</p>
</li>
<li><p>SOURCE_HOST：主库地址</p>
</li>
<li><p>SOURCE_USER：从主库进行主从复制的账户</p>
</li>
<li><p>SOURCE_PASSWORD：账户密码</p>
</li>
<li><p>SOURCE_LOG_FILE：从主库哪一个binlog开始复制，在主库中执行了<code>show master status;</code>查看到的</p>
</li>
<li><p>SOURCE_LOG_POS：从binlog哪个位置开始复制</p>
</li>
<li><p>上述是8.0.23中的语法（兼容了8.0.23 之前的表述）。如果mysql是 8.0.23 之前的版本，执行如下SQL：</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;192.168.200.200&#x27;</span>, MASTER_USER=<span class="string">&#x27;itcast&#x27;</span>,</span><br><span class="line">MASTER_PASSWORD=<span class="string">&#x27;Root@123456&#x27;</span>, MASTER_LOG_FILE=<span class="string">&#x27;binlog.000004&#x27;</span>,</span><br><span class="line">MASTER_LOG_POS= 663 ;</span><br></pre></td></tr></table></figure>

<ul>
<li>参数版本对比</li>
</ul>
<table>
<thead>
<tr>
<th>参数名</th>
<th>含义</th>
<th>8.0.23之前</th>
</tr>
</thead>
<tbody><tr>
<td>SOURCE_HOST</td>
<td>主库IP地址</td>
<td>MASTER_HOST</td>
</tr>
<tr>
<td>SOURCE_USER</td>
<td>连接主库的用户名</td>
<td>MASTER_USER</td>
</tr>
<tr>
<td>SOURCE_PASSWORD</td>
<td>连接主库的密码</td>
<td>MASTER_PASSWORD</td>
</tr>
<tr>
<td>SOURCE_LOG_FILE binlog</td>
<td>起始logbin日志文件名</td>
<td>MASTER_LOG_FILE</td>
</tr>
<tr>
<td>SOURCE_LOG_POS binlog</td>
<td>日志文件位置</td>
<td>MASTER_LOG_POS</td>
</tr>
</tbody></table>
<ol start="4">
<li>开启同步操作</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start replica ; <span class="comment">#8.0.22之后</span></span><br><span class="line">start slave ; <span class="comment">#8.0.22之前</span></span><br></pre></td></tr></table></figure>



<ol start="5">
<li>查看主从同步状态</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show replica status ; <span class="comment">#8.0.22之后</span></span><br><span class="line">show slave status ; <span class="comment">#8.0.22之前</span></span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/07/21/uqbBxYOF5RtE7IA.png" alt="image-20220720162937951"></p>
<h2 id="3-分库分表"><a href="#3-分库分表" class="headerlink" title="3.分库分表"></a>3.分库分表</h2><h3 id="1）基本概念-2"><a href="#1）基本概念-2" class="headerlink" title="1）基本概念"></a>1）基本概念</h3><p><img src="https://s2.loli.net/2022/07/21/qRbsd7AVSBz65Xh.png" alt="image-20220720173753588"></p>
<p>随着互联网及移动互联网的发展，应用系统的数据量也是成指数式增长，若采用单数据库进行数据存储，存在以下性能瓶颈：</p>
<ul>
<li><p>IO瓶颈</p>
<ul>
<li><p>热点数据太多，数据库缓存<strong>Buffer pool</strong>不足，产生大量磁盘IO，效率较低。 </p>
</li>
<li><p>请求数据太多，带宽不够，网络IO瓶颈。</p>
</li>
</ul>
</li>
<li><p>CPU瓶颈</p>
<ul>
<li>排序、分组、连接查询、聚合统计等SQL会耗费大量的CPU资源，请求数太多，CPU出<br>现瓶颈。</li>
</ul>
</li>
</ul>
<p>为了解决上述问题，我们需要对数据库进行分库分表处理：</p>
<p><img src="https://s2.loli.net/2022/07/21/GHyp5B2nRiAkTO8.png" alt="image-20220720174753626"></p>
<p>分库分表的中心思想都是将数据分散存储，使得单一数据库&#x2F;表的数据量变小来缓解单一数据库的性能问题，从而达到提升数据库性能的目的。</p>
<h3 id="2）分片策略"><a href="#2）分片策略" class="headerlink" title="2）分片策略"></a>2）分片策略</h3><h4 id="①基本概念-1"><a href="#①基本概念-1" class="headerlink" title="①基本概念"></a>①基本概念</h4><img src="https://s2.loli.net/2022/07/21/iCzwRgxaBIbs9Fv.png" alt="image-20220720174836849" style="zoom:80%;" />

<ul>
<li>分库、分表是粒度上的控制</li>
<li>垂直和水平</li>
<li>在业务系统中，为了缓解磁盘IO及CPU的性能瓶颈，到底是垂直拆分，还是水平拆分；具体是分<br>库，还是分表，都需要根据具体的业务需求具体分析</li>
</ul>
<h4 id="②垂直分库"><a href="#②垂直分库" class="headerlink" title="②垂直分库"></a>②垂直分库</h4><img src="https://s2.loli.net/2022/07/21/4rDN2u5I6XomSiV.png" alt="image-20220720174954832" style="zoom:80%;" />

<p>以库为单位，有用户user、订单order、库存sku三部分数据，可以将三部分数据分散到3个主机中</p>
<p>以表为依据，根据业务将不同表拆分到不同库中：</p>
<ul>
<li>每个库的表结构都不一样</li>
<li>每个库的数据也不一样</li>
<li>所有库的并集是全量数据</li>
</ul>
<h4 id="③垂直分表"><a href="#③垂直分表" class="headerlink" title="③垂直分表"></a>③垂直分表</h4><img src="https://s2.loli.net/2022/07/21/NRoBWic3mLefYUb.png" alt="image-20220720175417702" style="zoom:80%;" />

<p>以表为单位，将sku表按特性分类，比如部分<strong>sku信息</strong>和<strong>sku描述</strong></p>
<p>以字段为依据，根据字段属性将不同字段拆分到不同表中：</p>
<ul>
<li>每个表的结构都不一样</li>
<li>每个表的数据也不一样，一般通过一列（主键&#x2F;外键）关联</li>
<li>所有表的并集是全量数据</li>
</ul>
<h4 id="④水平分库"><a href="#④水平分库" class="headerlink" title="④水平分库"></a>④水平分库</h4><img src="https://s2.loli.net/2022/07/21/9EUjaVmhCKOqcQ2.png" alt="image-20220720192719282" style="zoom:80%;" />

<p>将数据库的表分散到多台主机，每台主机的表存部分数据（类似slots）</p>
<p>以字段为依据，按照一定策略，将一个库的数据拆分到多个库中：</p>
<ul>
<li>每个库的表结构都一样</li>
<li>每个库的数据都不一样</li>
<li>所有库的并集是全量数据</li>
</ul>
<h4 id="⑤水平分表"><a href="#⑤水平分表" class="headerlink" title="⑤水平分表"></a>⑤水平分表</h4><img src="https://s2.loli.net/2022/07/21/FNEjxPsyDI1ohiL.png" alt="image-20220720192952560" style="zoom:80%;" />

<p>其实就是以表的角度看水平分库</p>
<p>水平分表：以字段为依据，按照一定策略，将一个表的数据拆分到多个表中。<br>特点：</p>
<ul>
<li>每个表的表结构都一样</li>
<li>每个表的数据都不一样</li>
<li>所有表的并集是全量数据</li>
</ul>
<h4 id="⑥实现技术"><a href="#⑥实现技术" class="headerlink" title="⑥实现技术"></a>⑥实现技术</h4><ul>
<li>shardingJDBC：基于AOP原理，在应用程序中对本地执行的SQL进行拦截，解析、改写、路由处理。需要自行编码配置实现，只支持java语言，性能较高</li>
<li>MyCat：数据库分库分表中间件，不用调整代码即可实现分库分表，支持多种语言，性能不及前者</li>
</ul>
<h3 id="3）Mycat的概述"><a href="#3）Mycat的概述" class="headerlink" title="3）Mycat的概述"></a>3）Mycat的概述</h3><h4 id="①基本概念-2"><a href="#①基本概念-2" class="headerlink" title="①基本概念"></a>①基本概念</h4><p><img src="https://s2.loli.net/2022/07/21/58kGVyh4Km3MOJW.png" alt="image-20220720193508250"></p>
<ul>
<li><p>Mycat是开源的、活跃的、基于Java语言编写的MySQL数据库中间件。可以像使用mysql一样来使用mycat，对于开发人员来说根本感觉不到mycat的存在</p>
</li>
<li><p>开发人员只需要连接MyCat即可，而具体底层用到几台数据库，每一台数据库服务器里面存储了什么数据，都无需关心。 具体的分库分表的策略，只需要在MyCat中配置即可</p>
<ul>
<li>这就意味着对我们来说就正常进行数据库操作，具体的分发策略交给mycat处理</li>
</ul>
</li>
<li><p>优势：</p>
<ul>
<li><p>性能可靠稳定</p>
</li>
<li><p>强大的技术团队</p>
</li>
<li><p>体系完善</p>
</li>
<li><p>社区活跃</p>
</li>
</ul>
</li>
</ul>
<h4 id="②目录结构"><a href="#②目录结构" class="headerlink" title="②目录结构"></a>②目录结构</h4><p><img src="https://s2.loli.net/2022/07/21/T2auHMiWUhk1Y9R.png" alt="image-20220720193831217"></p>
<ul>
<li>bin : 存放可执行文件，用于启动停止mycat</li>
<li>conf：存放mycat的配置文件</li>
<li>lib：存放mycat的项目依赖包（jar）</li>
<li>logs：存放mycat的日志文件</li>
</ul>
<h4 id="③基本结构"><a href="#③基本结构" class="headerlink" title="③基本结构"></a>③基本结构</h4><p><img src="https://s2.loli.net/2022/07/21/7SM1yJNnfo4FU8i.png" alt="image-20220720194014756"></p>
<p>在MyCat的整体结构中，分为两个部分：上面的逻辑结构、下面的物理结构：</p>
<ul>
<li>逻辑结构<ul>
<li>逻辑结构主要负责逻辑库、逻辑表、分片规则、分片节点等逻辑结构的处理</li>
</ul>
</li>
<li>物理结构：<ul>
<li>具体的数据存储还是在物理结构，也就是数据库服务器中存储的</li>
</ul>
</li>
</ul>
<h3 id="4）Mycat-example"><a href="#4）Mycat-example" class="headerlink" title="4）Mycat example"></a>4）Mycat example</h3><h4 id="①需求"><a href="#①需求" class="headerlink" title="①需求"></a>①需求</h4><p>由于 tb_order 表中数据量很大，磁盘IO及容量都到达了瓶颈，现在需要对 tb_order 表进行数据分片，分为三个数据节点，每一个节点主机位于不同的服务器上, 具体的结构，参考下图：</p>
<img src="https://s2.loli.net/2022/07/21/VESnA2J4sXuYFN9.png" alt="image-20220720194308504" style="zoom: 67%;" />



<h4 id="②环境准备"><a href="#②环境准备" class="headerlink" title="②环境准备"></a>②环境准备</h4><p>准备 3 台服务器：</p>
<ul>
<li>192.168.200.210：MyCat中间件服务器，同时也是第一个分片服务器。</li>
<li>192.168.200.213：第二个分片服务器。</li>
<li>192.168.200.214：第三个分片服务器。</li>
</ul>
<p>并且在上述 3 台数据库中创建数据库 db01 </p>
<img src="https://s2.loli.net/2022/07/21/3GFQHgfcTEai5JL.png" alt="image-20220720194444077" style="zoom: 67%;" />



<h4 id="③配置"><a href="#③配置" class="headerlink" title="③配置"></a>③配置</h4><p><strong>schema.xml</strong></p>
<p>在schema.xml中配置逻辑库、逻辑表、数据节点、节点主机等相关信息。具体的配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mycat</span>:schema <span class="keyword">SYSTEM</span> <span class="string">&quot;schema.dtd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--逻辑库，逻辑表--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mycat:schema</span> <span class="attr">xmlns:mycat</span>=<span class="string">&quot;http://io.mycat/&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;DB01&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;TB_ORDER&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1,dn2,dn3&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;auto-sharding-long&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--逻辑表及节点关系--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db01&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db01&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost3&quot;</span> <span class="attr">database</span>=<span class="string">&quot;db01&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--节点主机配置--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span><span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span><span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master&quot;</span><span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.210:3306useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span><span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;1234&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span> <span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.213:3306useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;1234&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost3&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span><span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span> <span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.214:3306useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span> <span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;1234&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mycat:schema</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>server.xml</strong></p>
<p>需要在server.xml中配置用户名、密码，以及用户的访问权限信息，具体的配置如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span> 123456 <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>DB01<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="comment">&lt;!--能够访问的数据库--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 表级 DML 权限设置 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    &lt;privileges check=&quot;true&quot;&gt;</span></span><br><span class="line"><span class="comment">    &lt;schema name=&quot;DB01&quot; dml=&quot;0110&quot; &gt;</span></span><br><span class="line"><span class="comment">    &lt;table name=&quot;TB_ORDER&quot; dml=&quot;1110&quot;&gt;&lt;/table&gt;</span></span><br><span class="line"><span class="comment">    &lt;/schema&gt;</span></span><br><span class="line"><span class="comment">    &lt;/privileges&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span> 123456 <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>DB01<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;readOnly&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h4 id="④使用"><a href="#④使用" class="headerlink" title="④使用"></a>④使用</h4><p><strong>启动</strong><br>配置完毕后，先启动涉及到的 3 台分片服务器，然后启动MyCat服务器。切换到Mycat的安装目录，执行如下指令，启动Mycat：<br>Mycat启动之后，占用端口号 8066 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#启动</span><br><span class="line">bin/mycat start</span><br><span class="line">#停止</span><br><span class="line">bin/mycat stop</span><br></pre></td></tr></table></figure>

<p>启动完毕之后，可以查看logs目录下的启动日志，查看Mycat是否启动完成。</p>
<p><img src="https://s2.loli.net/2022/07/21/mYZtMlBjqinsGku.png" alt="image-20220720202949894"></p>
<p><strong>连接MyCat</strong><br>通过如下指令，就可以连接并登陆MyCat。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h 192.168.200.210 -P 8066 -uroot -p</span><br></pre></td></tr></table></figure>

<p>我们看到我们是通过MySQL的指令来连接的MyCat，因为MyCat在底层实际上是模拟了MySQL的协议。</p>
<p><strong>数据测试</strong><br>然后就可以在MyCat中来创建表，并往表结构中插入数据，查看数据在MySQL中的分布情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE TB_ORDER (</span><br><span class="line"><span class="built_in">id</span> BIGINT( 20 ) NOT NULL,</span><br><span class="line">title VARCHAR( 100 ) NOT NULL ,</span><br><span class="line">PRIMARY KEY (<span class="built_in">id</span>)</span><br><span class="line">) ENGINE=INNODB DEFAULT CHARSET=utf8 ;</span><br><span class="line"></span><br><span class="line">INSERT INTO TB_ORDER(<span class="built_in">id</span>,title) VALUES( 1 ,<span class="string">&#x27;goods1&#x27;</span>);</span><br><span class="line">INSERT INTO TB_ORDER(<span class="built_in">id</span>,title) VALUES( 2 ,<span class="string">&#x27;goods2&#x27;</span>);</span><br><span class="line">INSERT INTO TB_ORDER(<span class="built_in">id</span>,title) VALUES( 3 ,<span class="string">&#x27;goods3&#x27;</span>);</span><br><span class="line">INSERT INTO TB_ORDER(<span class="built_in">id</span>,title) VALUES( 1 ,<span class="string">&#x27;goods1&#x27;</span>);</span><br><span class="line">INSERT INTO TB_ORDER(<span class="built_in">id</span>,title) VALUES( 2 ,<span class="string">&#x27;goods2&#x27;</span>);</span><br><span class="line">INSERT INTO TB_ORDER(<span class="built_in">id</span>,title) VALUES( 3 ,<span class="string">&#x27;goods3&#x27;</span>);</span><br><span class="line"></span><br><span class="line">INSERT INTO TB_ORDER(<span class="built_in">id</span>,title) VALUES( 5000000 ,<span class="string">&#x27;goods5000000&#x27;</span>);</span><br><span class="line">INSERT INTO TB_ORDER(<span class="built_in">id</span>,title) VALUES( 10000000 ,<span class="string">&#x27;goods10000000&#x27;</span>);</span><br><span class="line">INSERT INTO TB_ORDER(<span class="built_in">id</span>,title) VALUES( 10000001 ,<span class="string">&#x27;goods10000001&#x27;</span>);</span><br><span class="line">INSERT INTO TB_ORDER(<span class="built_in">id</span>,title) VALUES( 15000000 ,<span class="string">&#x27;goods15000000&#x27;</span>);</span><br><span class="line">INSERT INTO TB_ORDER(<span class="built_in">id</span>,title) VALUES( 15000001 ,<span class="string">&#x27;goods15000001&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>经过测试，我们发现，在往 TB_ORDER 表中插入数据时：</p>
<ul>
<li><p>如果id的值在1-500w之间，数据将会存储在第一个分片数据库中。</p>
</li>
<li><p>如果id的值在500w-1000w之间，数据将会存储在第二个分片数据库中。</p>
</li>
<li><p>如果id的值在1000w-1500w之间，数据将会存储在第三个分片数据库中。</p>
</li>
<li><p>如果id的值超出1500w，在插入数据时，将会报错。</p>
</li>
</ul>
<p>这是跟之前xml配置中的分片策略有关</p>
<h3 id="5）Mycat-配置"><a href="#5）Mycat-配置" class="headerlink" title="5）Mycat 配置"></a>5）Mycat 配置</h3><h4 id="①schema-xml"><a href="#①schema-xml" class="headerlink" title="①schema.xml"></a>①schema.xml</h4><p>schema.xml作为MyCat中最重要的配置文件之一 , 涵盖了MyCat的逻辑库 、 逻辑表 、 分片规则、分片节点及数据源的配置。</p>
<p><img src="https://s2.loli.net/2022/07/21/wVWJLjO3Q6monyc.png" alt="image-20220720204541200"></p>
<p>主要包含以下三组标签：</p>
<ul>
<li>schema标签</li>
<li>datanode标签</li>
<li>datahost标签</li>
</ul>
<h5 id="a）schema-标签"><a href="#a）schema-标签" class="headerlink" title="a）schema 标签"></a>a）schema 标签</h5><p><strong>schema 定义逻辑库</strong></p>
<p><img src="https://s2.loli.net/2022/07/21/nveVBk9r3ZhOPYi.png" alt="image-20220720204613985"></p>
<p>schema 标签用于定义 MyCat实例中的逻辑库 , 一个MyCat实例中, 可以有多个逻辑库 , 可以通过 schema 标签来划分不同的逻辑库。MyCat中的逻辑库的概念，等同于MySQL中的database概念, 需要操作某个逻辑库下的表时, 也需要切换逻辑库(use xxx)。</p>
<p>核心属性：</p>
<ul>
<li>name：指定自定义的逻辑库库名</li>
<li>checkSQLschema：在SQL语句操作时指定了数据库名称，执行时是否自动去除；true：自动去除，false：不自动去除</li>
<li>sqlMaxLimit：如果未指定limit进行查询，列表查询模式查询多少条记录</li>
</ul>
<p><strong>schema 中的table定义逻辑表</strong></p>
<p><img src="https://s2.loli.net/2022/07/21/qzRZPhK6FY98UQj.png" alt="image-20220720204758236"></p>
<p>table 标签定义了MyCat中逻辑库schema下的逻辑表 , 所有需要拆分的表都需要在table标签中定义 。</p>
<p>核心属性：</p>
<ul>
<li>name：定义逻辑表表名，在该逻辑库下唯一</li>
<li>dataNode：定义逻辑表所属的dataNode，该属性需要与dataNode标签中name对应；多个</li>
<li>dataNode逗号分隔</li>
<li>rule：分片规则的名字，分片规则名字是在rule.xml中定义的</li>
<li>primaryKey：逻辑表对应真实表的主键</li>
<li>type：逻辑表的类型，目前逻辑表只有全局表和普通表，如果未配置，就是普通表；全局表，配置为 global</li>
</ul>
<h5 id="b）datanode标签"><a href="#b）datanode标签" class="headerlink" title="b）datanode标签"></a>b）datanode标签</h5><img src="https://s2.loli.net/2022/07/21/GSUOiK8gIDcqQtR.png" alt="image-20220720204923595" style="zoom:80%;" />

<p>核心属性：</p>
<ul>
<li>name：定义数据节点名称</li>
<li>dataHost：数据库实例主机名称，引用自 dataHost 标签中name属性</li>
<li>database：定义分片所属数据库</li>
</ul>
<h5 id="c）datahost标签"><a href="#c）datahost标签" class="headerlink" title="c）datahost标签"></a>c）datahost标签</h5><p><img src="https://s2.loli.net/2022/07/21/qze5NpQyXkYcrMD.png" alt="image-20220720204955585"></p>
<p>该标签在MyCat逻辑库中作为底层标签存在, 直接定义了具体的数据库实例、读写分离、心跳语句。<br>核心属性：</p>
<ul>
<li>name：唯一标识，供上层标签使用</li>
<li>maxCon&#x2F;minCon：最大连接数&#x2F;最小连接数</li>
<li>balance：负载均衡策略，取值 0,1,2,3</li>
<li>writeType：写操作分发方式（ 0 ：写操作转发到第一个writeHost，第一个挂了，切换到第二个； 1 ：写操作随机分发到配置的writeHost）</li>
<li>dbDriver：数据库驱动，支持 native、jdbc</li>
</ul>
<h4 id="②rule-xml"><a href="#②rule-xml" class="headerlink" title="②rule.xml"></a>②rule.xml</h4><p>rule.xml中定义所有拆分表的规则, 在使用过程中可以灵活的使用分片算法, 或者对同一个分片算法使用不同的参数, 它让分片过程可配置化。主要包含两类标签：tableRule、Function：</p>
<img src="https://s2.loli.net/2022/07/21/r37Vsjx9d6KPnu2.png" alt="image-20220720205137918" style="zoom:80%;" />



<h4 id="③server-xml"><a href="#③server-xml" class="headerlink" title="③server.xml"></a>③server.xml</h4><p>server.xml配置文件包含了MyCat的系统配置信息，主要有两个重要的标签：system、user：</p>
<h5 id="a）system标签"><a href="#a）system标签" class="headerlink" title="a）system标签"></a>a）system标签</h5><img src="https://s2.loli.net/2022/07/21/6bXVimYxZtgrIy3.png" alt="image-20220720205314030" style="zoom:80%;" />

<p>主要配置MyCat中的系统配置信息，对应的系统配置项及其含义，如下：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>取值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>charset</td>
<td>utf8</td>
<td>设置Mycat的字符集,  字符集需要与MySQL的字符集保持一致</td>
</tr>
<tr>
<td>nonePasswordLogin</td>
<td>0,1</td>
<td>0为需要密码登陆、1为不需要密码登陆  ,默认为0，设置为1则需要指定默认账户</td>
</tr>
<tr>
<td>useHandshakeV10</td>
<td>0,1</td>
<td>使用该选项主要的目的是为了能够兼容高版本的jdbc驱动,  是否采用HandshakeV10Packet来与client进行通信, 1:是, 0:否</td>
</tr>
<tr>
<td>useSqlStat</td>
<td>0,1</td>
<td>开启SQL实时统计,  1 为开启 , 0 为关闭 ; 开启之后, MyCat会自动统计SQL语句的执行情况 ; mysql -h 127.0.0.1 -P 9066 -u  root -p 查看MyCat执行的SQL, 执行效率比较低的SQL , SQL的整体执行情况、读写比例等 ; show @@sql ; show  @@sql.slow ; show @@sql.sum ;</td>
</tr>
<tr>
<td>useGlobleTableCheck</td>
<td>0,1</td>
<td>是否开启全局表的一致性检测。1为开启  ，0为关闭 。</td>
</tr>
<tr>
<td>sqlExecuteTimeout</td>
<td>1000</td>
<td>SQL语句执行的超时时间  , 单位为 s ;</td>
</tr>
<tr>
<td>sequnceHandlerType</td>
<td>0,1,2</td>
<td>用来指定Mycat全局序列类型，0  为本地文件，1 为数据库方式，2 为时间戳列方式，默认使用本地文件方式，文件方式主要用于测试</td>
</tr>
<tr>
<td>sequnceHandlerPattern</td>
<td>正则表达式</td>
<td>必须带有MYCATSEQ或者  mycatseq进入序列匹配流程 注意MYCATSEQ_有空格的情况</td>
</tr>
<tr>
<td>subqueryRelationshipCheck</td>
<td>true,false</td>
<td>子查询中存在关联查询的情况下,检查关联字段中是否有分片字段  .默认 false</td>
</tr>
<tr>
<td>useCompression</td>
<td>0,1</td>
<td>开启mysql压缩协议  , 0 : 关闭, 1 : 开启</td>
</tr>
<tr>
<td>fakeMySQLVersion</td>
<td>5.5,5.6</td>
<td>设置模拟的MySQL版本号</td>
</tr>
<tr>
<td>defaultSqlParser</td>
<td></td>
<td>由于MyCat的最初版本使用了FoundationDB的SQL解析器,  在MyCat1.3后增加了Druid解析器, 所以要设置defaultSqlParser属性来指定默认的解析器; 解析器有两个 : druidparser  和 fdbparser, 在MyCat1.4之后,默认是druidparser, fdbparser已经废除了</td>
</tr>
<tr>
<td>processors</td>
<td>1,2….</td>
<td>指定系统可用的线程数量,  默认值为CPU核心 x 每个核心运行线程数量; processors 会影响processorBufferPool,  processorBufferLocalPercent, processorExecutor属性, 所有, 在性能调优时,  可以适当地修改processors值</td>
</tr>
<tr>
<td>processorBufferChunk</td>
<td></td>
<td>指定每次分配Socket  Direct Buffer默认值为4096字节, 也会影响BufferPool长度, 如果一次性获取字节过多而导致buffer不够用, 则会出现警告,  可以调大该值</td>
</tr>
<tr>
<td>processorExecutor</td>
<td></td>
<td>指定NIOProcessor上共享  businessExecutor固定线程池的大小; MyCat把异步任务交给 businessExecutor线程池中,  在新版本的MyCat中这个连接池使用频次不高, 可以适当地把该值调小</td>
</tr>
<tr>
<td>packetHeaderSize</td>
<td></td>
<td>指定MySQL协议中的报文头长度,  默认4个字节</td>
</tr>
<tr>
<td>maxPacketSize</td>
<td></td>
<td>指定MySQL协议可以携带的数据最大大小,  默认值为16M</td>
</tr>
<tr>
<td>idleTimeout</td>
<td>30</td>
<td>指定连接的空闲时间的超时长度;如果超时,将关闭资源并回收,  默认30分钟</td>
</tr>
<tr>
<td>txIsolation</td>
<td>1,2,3,4</td>
<td>初始化前端连接的事务隔离级别,默认为  REPEATED_READ , 对应数字为3 READ_UNCOMMITED&#x3D;1; READ_COMMITTED&#x3D;2; REPEATED_READ&#x3D;3;  SERIALIZABLE&#x3D;4;</td>
</tr>
<tr>
<td>sqlExecuteTimeout</td>
<td>300</td>
<td>执行SQL的超时时间,  如果SQL语句执行超时,将关闭连接; 默认300秒;</td>
</tr>
<tr>
<td>serverPort</td>
<td>8066</td>
<td>定义MyCat的使用端口,  默认8066</td>
</tr>
<tr>
<td>managerPort</td>
<td>9066</td>
<td>定义MyCat的管理端口,  默认9066</td>
</tr>
</tbody></table>
<h5 id="b）user标签"><a href="#b）user标签" class="headerlink" title="b）user标签"></a>b）user标签</h5><p>配置MyCat中的用户、访问密码，以及用户针对于逻辑库、逻辑表的权限信息，具体的权限描述方式及配置说明如下：</p>
<p><img src="https://s2.loli.net/2022/07/21/uHK5sjb3TvnVOcx.png" alt="image-20220720225334810"></p>
<p>在测试权限操作时，我们只需要将 privileges 标签的注释放开。 在 privileges 下的schema标签中配置的dml属性配置的是逻辑库的权限。 在privileges的schema下的table标签的dml属性中配置逻辑表的权限。</p>
<h3 id="6）Mycat-分片"><a href="#6）Mycat-分片" class="headerlink" title="6）Mycat 分片"></a>6）Mycat 分片</h3><h4 id="①垂直拆分"><a href="#①垂直拆分" class="headerlink" title="①垂直拆分"></a>①垂直拆分</h4><h5 id="a）场景"><a href="#a）场景" class="headerlink" title="a）场景"></a>a）场景</h5><p>在业务系统中, 涉及以下表结构 ,但是由于用户与订单每天都会产生大量的数据, 单台服务器的数据存储及处理能力是有限的, 可以对数据库表进行拆分, 原有的数据库表如下。</p>
<p><img src="https://s2.loli.net/2022/07/21/JGpaV8qb3cstwNH.png" alt="image-20220720232650345">现在考虑将其进行垂直分库操作，将商品相关的表拆分到一个数据库服务器，订单表拆分的一个数据库服务器，用户及省市区表拆分到一个服务器。最终结构如下：</p>
<p><img src="https://s2.loli.net/2022/07/21/QTFty7m3qkZAGlW.png" alt="image-20220720232904140"></p>
<h5 id="b）配置"><a href="#b）配置" class="headerlink" title="b）配置"></a>b）配置</h5><p><strong>schema.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;SHOPPING&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_goods_base&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_goods_brand&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_goods_cat&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_goods_desc&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;goods_id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_goods_item&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_order_item&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_order_master&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;order_id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_order_pay_log&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;out_trade_no&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_user_address&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_areas_provinces&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_areas_city&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_areas_region&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn1&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;shopping&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn2&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;shopping&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn3&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost3&quot;</span> <span class="attr">database</span>=<span class="string">&quot;shopping&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.210:3306?</span></span></span><br><span class="line"><span class="string"><span class="tag">useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;1234&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.213:3306?</span></span></span><br><span class="line"><span class="string"><span class="tag">useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;1234&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataHost</span> <span class="attr">name</span>=<span class="string">&quot;dhost3&quot;</span> <span class="attr">maxCon</span>=<span class="string">&quot;1000&quot;</span> <span class="attr">minCon</span>=<span class="string">&quot;10&quot;</span> <span class="attr">balance</span>=<span class="string">&quot;0&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">writeType</span>=<span class="string">&quot;0&quot;</span> <span class="attr">dbType</span>=<span class="string">&quot;mysql&quot;</span> <span class="attr">dbDriver</span>=<span class="string">&quot;jdbc&quot;</span> <span class="attr">switchType</span>=<span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">slaveThreshold</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">heartbeat</span>&gt;</span>select user()<span class="tag">&lt;/<span class="name">heartbeat</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">writeHost</span> <span class="attr">host</span>=<span class="string">&quot;master&quot;</span> <span class="attr">url</span>=<span class="string">&quot;jdbc:mysql://192.168.200.214:3306?</span></span></span><br><span class="line"><span class="string"><span class="tag">useSSL=false<span class="symbol">&amp;amp;</span>serverTimezone=Asia/Shanghai<span class="symbol">&amp;amp;</span>characterEncoding=utf8&quot;</span></span></span><br><span class="line"><span class="tag"><span class="attr">user</span>=<span class="string">&quot;root&quot;</span> <span class="attr">password</span>=<span class="string">&quot;1234&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dataHost</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p><strong>server.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span> 123456 <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>SHOPPING<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 表级 DML 权限设置 --&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">        &lt;privileges check=&quot;true&quot;&gt;</span></span><br><span class="line"><span class="comment">        &lt;schema name=&quot;DB01&quot; dml=&quot;0110&quot; &gt;</span></span><br><span class="line"><span class="comment">        &lt;table name=&quot;TB_ORDER&quot; dml=&quot;1110&quot;&gt;&lt;/table&gt;</span></span><br><span class="line"><span class="comment">        &lt;/schema&gt;</span></span><br><span class="line"><span class="comment">        &lt;/privileges&gt;</span></span><br><span class="line"><span class="comment">        --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span> 123456 <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>SHOPPING<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;readOnly&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h5 id="c）测试"><a href="#c）测试" class="headerlink" title="c）测试"></a>c）测试</h5><p>在MyCat的命令行中，当我们执行以下多表联查的SQL语句时，可以正常查询出数据：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select ua.user_id, ua.contact, p.province, c.city, r.area , ua.address from</span><br><span class="line">tb_user_address ua ,tb_areas_city c , tb_areas_provinces p ,tb_areas_region r</span><br><span class="line"><span class="built_in">where</span> ua.province_id = p.provinceid and ua.city_id = c.cityid and ua.town_id =</span><br><span class="line">r.areaid ;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/07/21/f6T9mzyKDMjhOUG.png" alt="image-20220720233646582"></p>
<p>那么以下sql呢？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT order_id , payment ,receiver, province , city , area FROM tb_order_master o</span><br><span class="line">, tb_areas_provinces p , tb_areas_city c , tb_areas_region r WHERE</span><br><span class="line">o.receiver_province = p.provinceid AND o.receiver_city = c.cityid AND</span><br><span class="line">o.receiver_region = r.areaid ;</span><br></pre></td></tr></table></figure>

<p>现在存在一个问题，订单相关的表结构是在 192.168.200.213 数据库服务器中，而省市区的数据库表是在 192.168.200.214 数据库服务器中。那么在MyCat中执行是否可以成功呢？</p>
<p><img src="https://s2.loli.net/2022/07/21/k5xTrNLZu4wpyFU.png" alt="image-20220720233906998"></p>
<p><img src="https://s2.loli.net/2022/07/21/gLPz2n7CJowHKZu.png" alt="image-20220720233534510"></p>
<p>经过测试，我们看到，SQL语句执行报错。原因就是因为MyCat在执行该SQL语句时，需要往具体的数据库服务器中路由，而当前没有一个数据库服务器完全包含了订单以及省市区的表结构，造成SQL语句失败，报错。</p>
<h5 id="d）全局表"><a href="#d）全局表" class="headerlink" title="d）全局表"></a>d）全局表</h5><p>对于省、市、区&#x2F;县表tb_areas_provinces , tb_areas_city , tb_areas_region，是属于数据字典表，在多个业务模块中都可能会遇到，可以将其设置为全局表，利于业务操作。<br>修改schema.xml中的逻辑表的配置，修改 tb_areas_provinces、tb_areas_city、tb_areas_region 三个逻辑表，增加 type 属性，配置为global，就代表该表是全局表，就会在所涉及到的dataNode中创建给表。对于当前配置来说，也就意味着所有的节点中都有该表了。</p>
<ul>
<li>当在MyCat中更新全局表的时候，所有分片节点中的数据都发生了变化，每个节点的全局表数据时刻保持一致。</li>
</ul>
<p><img src="https://s2.loli.net/2022/07/21/5MYLQu9rziwUpGV.png" alt="image-20220720234211605"></p>
<p>修改后，结构如下：</p>
<img src="https://s2.loli.net/2022/07/21/TnbXmgQaCJE5WZM.png" alt="image-20220720234300068" style="zoom:80%;" />

<p>再次执行之前的sql，可以成功执行。</p>
<h4 id="②水平拆分"><a href="#②水平拆分" class="headerlink" title="②水平拆分"></a>②水平拆分</h4><h5 id="a）场景-1"><a href="#a）场景-1" class="headerlink" title="a）场景"></a>a）场景</h5><img src="https://s2.loli.net/2022/07/21/VFC5Gc2svUKIHZa.png" alt="image-20220721123824553" style="zoom:80%;" />

<p>​		在业务系统中, 有一张表(日志表), 业务系统每天都会产生大量的日志数据 , 单台服务器的数据存储及处理能力是有限的, 可以对数据库表进行拆分。在三台主机上共同存储log数据</p>
<h5 id="b）配置-1"><a href="#b）配置-1" class="headerlink" title="b）配置"></a>b）配置</h5><p><strong>schema.xml</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">name</span>=<span class="string">&quot;ITCAST&quot;</span> <span class="attr">checkSQLschema</span>=<span class="string">&quot;true&quot;</span> <span class="attr">sqlMaxLimit</span>=<span class="string">&quot;100&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span> <span class="attr">name</span>=<span class="string">&quot;tb_log&quot;</span> <span class="attr">dataNode</span>=<span class="string">&quot;dn4,dn5,dn6&quot;</span> <span class="attr">primaryKey</span>=<span class="string">&quot;id&quot;</span> <span class="attr">rule</span>=<span class="string">&quot;mod-long&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn4&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost1&quot;</span> <span class="attr">database</span>=<span class="string">&quot;itcast&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn5&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost2&quot;</span> <span class="attr">database</span>=<span class="string">&quot;itcast&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dataNode</span> <span class="attr">name</span>=<span class="string">&quot;dn6&quot;</span> <span class="attr">dataHost</span>=<span class="string">&quot;dhost3&quot;</span> <span class="attr">database</span>=<span class="string">&quot;itcast&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>rule=&quot;mod-long&quot;</code>，采用的是取模策略<ul>
<li>可以在<strong>rule.xml</strong>中配置模的数字</li>
<li><img src="https://s2.loli.net/2022/07/21/2X4bD7YqUxryLoC.png" alt="image-20220721124500292" style="zoom:80%;" /></li>
</ul>
</li>
<li>tb_log表最终落在 3 个节点中，分别是 dn4、dn5、dn6 ，而具体的数据分别存储在 dhost1、dhost2、dhost3的itcast数据库中。</li>
</ul>
<p><strong>server.xml</strong><br>配置root用户既可以访问 SHOPPING 逻辑库，又可以访问ITCAST逻辑库。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span> 123456 <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>SHOPPING,ITCAST<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 表级 DML 权限设置 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    &lt;privileges check=&quot;true&quot;&gt;</span></span><br><span class="line"><span class="comment">    &lt;schema name=&quot;DB01&quot; dml=&quot;0110&quot; &gt;</span></span><br><span class="line"><span class="comment">    &lt;table name=&quot;TB_ORDER&quot; dml=&quot;1110&quot;&gt;&lt;/table&gt;</span></span><br><span class="line"><span class="comment">    &lt;/schema&gt;</span></span><br><span class="line"><span class="comment">    &lt;/privileges&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="7）Mycat-分片策略"><a href="#7）Mycat-分片策略" class="headerlink" title="7）Mycat 分片策略"></a>7）Mycat 分片策略</h3><h4 id="①范围分片"><a href="#①范围分片" class="headerlink" title="①范围分片"></a>①范围分片</h4><h5 id="a）场景-2"><a href="#a）场景-2" class="headerlink" title="a）场景"></a>a）场景</h5><img src="https://s2.loli.net/2022/07/21/PWoNntGs6fSqz9p.png" alt="image-20220721124745955" style="zoom: 67%;" />



<h5 id="b）配置-2"><a href="#b）配置-2" class="headerlink" title="b）配置"></a>b）配置</h5><p><img src="https://s2.loli.net/2022/07/21/WDLnzAelRHisuyJ.png" alt="image-20220721124957226"></p>
<h4 id="②取模分片"><a href="#②取模分片" class="headerlink" title="②取模分片"></a>②取模分片</h4><h5 id="a）场景-3"><a href="#a）场景-3" class="headerlink" title="a）场景"></a>a）场景</h5><img src="https://s2.loli.net/2022/07/21/Clu2wF1mYDtg8Sa.png" alt="image-20220721132653128" style="zoom:50%;" />

<ul>
<li>根据指定的字段值与节点数量进行求模运算，根据运算结果， 来决定该数据属于哪一个分片</li>
<li>主要针对的是整数型id，如果id是uuid则需要hash算法</li>
</ul>
<h5 id="b）配置-3"><a href="#b）配置-3" class="headerlink" title="b）配置"></a>b）配置</h5><p><img src="https://s2.loli.net/2022/07/21/OsBgUe1t9jzxaZ2.png" alt="image-20220721132800795"></p>
<h4 id="③一致性hash分片"><a href="#③一致性hash分片" class="headerlink" title="③一致性hash分片"></a>③一致性hash分片</h4><h5 id="a）场景-4"><a href="#a）场景-4" class="headerlink" title="a）场景"></a>a）场景</h5><img src="https://s2.loli.net/2022/07/21/SPR8Fp6azq7ycIA.png" alt="image-20220721133009869" style="zoom:67%;" />

<ul>
<li>一致性哈希就是将相同的哈希因子计算值总是被划分到相同的分区表中，不会因为分区节点的增加而改变原来数据的分区位置，有效的解决了分布式数据的拓容问题。<ul>
<li>如一开始只有3个节点，数据计算后落入节点2，如果再新增一个新的节点4，数据不会因节点增加而被计算到其它节点，这和取模的hash算法不同，不受新增节点的影响</li>
</ul>
</li>
<li>适用于uuid生成的id（不能取模）</li>
</ul>
<h5 id="b）配置-4"><a href="#b）配置-4" class="headerlink" title="b）配置"></a>b）配置</h5><p><img src="https://s2.loli.net/2022/07/21/vxwizPVYB17RUn8.png" alt="image-20220721133149799"></p>
<h4 id="④枚举分片"><a href="#④枚举分片" class="headerlink" title="④枚举分片"></a>④枚举分片</h4><h5 id="a）场景-5"><a href="#a）场景-5" class="headerlink" title="a）场景"></a>a）场景</h5><img src="https://s2.loli.net/2022/07/21/e43nVwP6ubEYl91.png" alt="image-20220721133540397" style="zoom: 67%;" />

<ul>
<li>通过在配置文件中配置可能的枚举值, 指定数据分布到不同数据节点上, 本规则适用于按照省份、性别、状态拆分数据等业务 <ul>
<li>如一个省份的用户数据放在某一数据库</li>
</ul>
</li>
</ul>
<h5 id="b）配置-5"><a href="#b）配置-5" class="headerlink" title="b）配置"></a>b）配置</h5><p><img src="https://s2.loli.net/2022/07/21/NdGWvQgFCOszXTw.png" alt="image-20220721133949772"></p>
<h4 id="⑤应用指定算法"><a href="#⑤应用指定算法" class="headerlink" title="⑤应用指定算法"></a>⑤应用指定算法</h4><h5 id="a）场景-6"><a href="#a）场景-6" class="headerlink" title="a）场景"></a>a）场景</h5><p><img src="https://s2.loli.net/2022/07/21/rsoAqwlH4nKyaGz.png" alt="image-20220721134217796"></p>
<ul>
<li>运行阶段由应用自主决定路由到那个分片 , 直接根据字符子串（必须是数字）计算分片号</li>
<li>就是求某个字符串字段的subStr，然后根据subStr和映射配置分配到对应的节点<ul>
<li>如varchar类型的id：0100001,0200002….</li>
</ul>
</li>
</ul>
<h5 id="b）配置-6"><a href="#b）配置-6" class="headerlink" title="b）配置"></a>b）配置</h5><p><img src="https://s2.loli.net/2022/07/21/jJkgz4xZtdiNeIO.png" alt="image-20220721134422034"></p>
<h4 id="⑥固定hash算法"><a href="#⑥固定hash算法" class="headerlink" title="⑥固定hash算法"></a>⑥固定hash算法</h4><h5 id="a）场景-7"><a href="#a）场景-7" class="headerlink" title="a）场景"></a>a）场景</h5><img src="https://s2.loli.net/2022/07/21/RTQEzvpBJ7GPYgd.png" alt="image-20220721135945682" style="zoom:80%;" />

<ul>
<li><p>如果是求模，连续的值，分别分配到各个不同的分片；但是此算法会将连续的值可能分配到相同的分片，降低事务处理的难度</p>
<ul>
<li>最后10位和全1做&amp;运算</li>
</ul>
</li>
<li><p>可以均匀分配，也可以非均匀分配。</p>
</li>
<li><p>分片字段必须为<strong>数字类型</strong></p>
</li>
</ul>
<h5 id="b）配置-7"><a href="#b）配置-7" class="headerlink" title="b）配置"></a>b）配置</h5><p><img src="https://s2.loli.net/2022/07/21/OHIpoKh7FZwnGgJ.png" alt="image-20220721140616717"></p>
<h4 id="⑦字符串hash解析"><a href="#⑦字符串hash解析" class="headerlink" title="⑦字符串hash解析"></a>⑦字符串hash解析</h4><h5 id="a）场景-8"><a href="#a）场景-8" class="headerlink" title="a）场景"></a>a）场景</h5><p><img src="https://s2.loli.net/2022/07/21/u7jCsrwp5l1kB3c.png" alt="image-20220721141147269"></p>
<ul>
<li>截取字符串中的指定位置的子字符串, 进行hash算法， 算出分片<ul>
<li>其实就是对字符串型，非整数型数据进行hash处理</li>
</ul>
</li>
</ul>
<h5 id="b）配置-8"><a href="#b）配置-8" class="headerlink" title="b）配置"></a>b）配置</h5><p><img src="https://s2.loli.net/2022/07/21/xUoTrb8ftpCuwjl.png" alt="image-20220721141306571"></p>
<ul>
<li>512代表一个分区长度是512</li>
<li>2代表有2个分区，正好是1024</li>
<li>0:2，start:end，从0开始截，截到2</li>
<li>最后还是和10个1做&amp;运算</li>
</ul>
<h4 id="⑧按天分片"><a href="#⑧按天分片" class="headerlink" title="⑧按天分片"></a>⑧按天分片</h4><h5 id="a）场景-9"><a href="#a）场景-9" class="headerlink" title="a）场景"></a>a）场景</h5><img src="https://s2.loli.net/2022/07/21/1nYJquso7RbgDOc.png" alt="image-20220721142249394" style="zoom:80%;" />

<ul>
<li>按照日期及对应的时间周期来分片</li>
<li>配置的时间是2022-01-01<del>2022-01-30，如果到期后，比如2022-01-31</del>2022-02-09的数据就会放入第一个分片</li>
</ul>
<h5 id="b）配置-9"><a href="#b）配置-9" class="headerlink" title="b）配置"></a>b）配置</h5><p><img src="https://s2.loli.net/2022/07/21/wk5cJli4SPvoOxB.png" alt="image-20220721142600304"></p>
<ul>
<li>注意分片数量要和规则一致，这里只有3个分片，所以10天为一个周期进行分片</li>
</ul>
<h4 id="⑨按自然月分片"><a href="#⑨按自然月分片" class="headerlink" title="⑨按自然月分片"></a>⑨按自然月分片</h4><h5 id="a）场景-10"><a href="#a）场景-10" class="headerlink" title="a）场景"></a>a）场景</h5><img src="https://s2.loli.net/2022/07/21/6vkJMymdecAT4Pz.png" alt="image-20220721142859882" style="zoom: 80%;" />

<ul>
<li>使用场景为按照月份来分片, 每个自然月为一个分片</li>
<li>到期后又继续重新分片</li>
</ul>
<h5 id="b）配置-10"><a href="#b）配置-10" class="headerlink" title="b）配置"></a>b）配置</h5><p><img src="https://s2.loli.net/2022/07/21/4DRJ1vZubwpznEQ.png" alt="image-20220721143051047"></p>
<ul>
<li>注意分片数量要和规则一致，这里只有3个分片所以配置的是1-3月</li>
</ul>
<h3 id="8）Mycat-管理和监控"><a href="#8）Mycat-管理和监控" class="headerlink" title="8）Mycat 管理和监控"></a>8）Mycat 管理和监控</h3><h4 id="①基本原理"><a href="#①基本原理" class="headerlink" title="①基本原理"></a>①基本原理</h4><p><img src="https://s2.loli.net/2022/07/21/R6ZouLfi2QdGJn8.png" alt="image-20220721145842864"></p>
<ul>
<li><p>在MyCat中，当执行一条SQL语句时，MyCat需要进行SQL解析、分片分析、路由分析、读写分离分析等操作，最终经过一系列的分析决定将当前的SQL语句到底路由到那几个(或哪一个)节点数据库，数据库将数据执行完毕后，如果有返回的结果，则将结果返回给MyCat，最终还需要在MyCat中进行结果合并、聚合处理、排序处理、分页处理等操作，最终再将结果返回给客户端。</p>
</li>
<li><p>在MyCat的使用过程中，MyCat官方也提供了一个管理监控平台MyCat-Web（MyCat-eye）。Mycat-web 是 Mycat 可视化运维的管和监控平台，弥补了 Mycat 在监控上的空白。帮 Mycat分担统计任务和配置管理任务。Mycat-web 引入了 ZooKeeper 作为配置中心，以管理多个节点。Mycat-web 主要管理和监控 Mycat 的流量、连接、活动线程和内存等，具备 IP 白名单、邮件告警等模块，还可以统计SQL 并分析慢 SQL 和高频 SQL 等。为优化 SQL 提供依据。</p>
</li>
</ul>
<h4 id="②Mycat-管理工具"><a href="#②Mycat-管理工具" class="headerlink" title="②Mycat 管理工具"></a>②Mycat 管理工具</h4><p>Mycat默认开通 2 个端口，可以在server.xml中进行修改。</p>
<ul>
<li>8066 数据访问端口，即进行 DML 和 DDL 操作。</li>
<li>9066 数据库管理端口，即 mycat 服务管理控制功能，用于管理mycat的整个集群状态</li>
</ul>
<p>连接MyCat的管理控制台：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -h 192.168.200.210 -p 9066 -uroot -p123456</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>命令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>show @@help</td>
<td>查看Mycat管理工具帮助文档</td>
</tr>
<tr>
<td>show</td>
<td>@@version 查看Mycat的版本</td>
</tr>
<tr>
<td>reload</td>
<td>@@config 重新加载Mycat的配置文件</td>
</tr>
<tr>
<td>show</td>
<td>@@datasource 查看Mycat的数据源信息</td>
</tr>
<tr>
<td>show</td>
<td>@@datanode 查看MyCat现有的分片节点信息</td>
</tr>
<tr>
<td>show</td>
<td>@@threadpool 查看Mycat的线程池信息</td>
</tr>
<tr>
<td>show</td>
<td>@@sql 查看执行的SQL</td>
</tr>
<tr>
<td>show</td>
<td>@@sql.sum 查看执行的SQL统计</td>
</tr>
</tbody></table>
<ul>
<li>该管理工具还是通过命令行的方式操作，整体还不是很直观</li>
</ul>
<h4 id="③Mycat-监控"><a href="#③Mycat-监控" class="headerlink" title="③Mycat 监控"></a>③Mycat 监控</h4><ul>
<li>Mycat-web(Mycat-eye)是对mycat-server提供监控服务，功能不局限于对mycat-server使用。他通过JDBC连接对Mycat、Mysql监控，监控远程服务器(目前仅限于linux系统)的cpu、内存、网络、磁盘。</li>
<li>Mycat-eye运行过程中需要依赖zookeeper，因此需要先安装zookeeper</li>
</ul>
<p>url访问如：<code>http://192.168.200.210:8082/mycat</code></p>
<p>浏览器连接后可以看到一个直观的分析：</p>
<p><img src="https://s2.loli.net/2022/07/21/AEdIe5PuLioskc3.png" alt="image-20220721152057693"></p>
<h2 id="4-读写分离"><a href="#4-读写分离" class="headerlink" title="4.读写分离"></a>4.读写分离</h2><h3 id="1）基本概念-3"><a href="#1）基本概念-3" class="headerlink" title="1）基本概念"></a>1）基本概念</h3><p><img src="https://s2.loli.net/2022/07/21/fb9IJ74NGWVgcE6.png" alt="image-20220721154407221"></p>
<ul>
<li>读写分离，简单地说是把对数据库的读和写操作分开,以对应不同的数据库服务器。主数据库提供写操作，从数据库提供读操作，这样能有效地减轻单台数据库的压力。</li>
<li>虽然我们实现了主从复制，但是编码的时候我们不太好编码，因为我们想写操作全部交给主节点执行，查询操作全部交给从节点执行，实现真正的读写分离，因此我们可以连接mycat，mycat来完成这部分逻辑判断。</li>
<li>通过MyCat即可轻易实现上述功能，不仅可以支持MySQL，也可以支持Oracle和SQL Server。</li>
</ul>
<h3 id="2）一主一从"><a href="#2）一主一从" class="headerlink" title="2）一主一从"></a>2）一主一从</h3><h4 id="①原理"><a href="#①原理" class="headerlink" title="①原理"></a>①原理</h4><img src="https://s2.loli.net/2022/07/21/JerfzYnSMUoLdt9.png" alt="image-20220721154630435" style="zoom:80%;" />

<ul>
<li>MySQL的主从复制，是基于二进制日志（binlog）实现的。</li>
<li>判断写操作和读操作的逻辑交给mycat</li>
</ul>
<h4 id="②搭建一主一从结构"><a href="#②搭建一主一从结构" class="headerlink" title="②搭建一主一从结构"></a>②搭建一主一从结构</h4><table>
<thead>
<tr>
<th>主机</th>
<th>角色</th>
<th>用户名</th>
<th>密码</th>
</tr>
</thead>
<tbody><tr>
<td>192.168.200.211</td>
<td>master</td>
<td>root</td>
<td>1234</td>
</tr>
<tr>
<td>192.168.200.212</td>
<td>slave</td>
<td>root</td>
<td>1234</td>
</tr>
</tbody></table>
<ul>
<li>具体搭建在主从复制处</li>
</ul>
<h4 id="③Mycat-配置读写分离"><a href="#③Mycat-配置读写分离" class="headerlink" title="③Mycat 配置读写分离"></a>③Mycat 配置读写分离</h4><h5 id="a）scheam-xml"><a href="#a）scheam-xml" class="headerlink" title="a）scheam.xml"></a>a）scheam.xml</h5><p><img src="https://s2.loli.net/2022/07/21/jsFT7ZdQAEIao4D.png" alt="image-20220721154730666"></p>
<ul>
<li><p>writeHost代表的是写操作对应的数据库，readHost代表的是读操作对应的数据库。 所以我们要想实现读写分离，就得配置writeHost关联的是主库，readHost关联的是从库。</p>
</li>
<li><p>而仅仅配置好了writeHost以及readHost还不能完成读写分离，还需要配置一个非常重要的负责均衡的参数 balance，取值有 4 种，具体含义如下：</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>参数值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>不开启读写分离机制 , 所有读操作都发送到当前可用的writeHost上（配置了readHost也没用）</td>
</tr>
<tr>
<td>1</td>
<td>全部的readHost与备用的writeHost都参与select 语句的负载均衡（主要针对于双主双从模式）</td>
</tr>
<tr>
<td>2</td>
<td>所有的读写操作都随机在writeHost , readHost上分发</td>
</tr>
<tr>
<td>3</td>
<td>所有的读请求随机分发到writeHost对应的readHost上执行, writeHost不负担读压力</td>
</tr>
</tbody></table>
<ul>
<li>因此要想实现读写分离，取值之能是1,3</li>
<li>在一主一从的情况下1和3效果都是一样的</li>
</ul>
<h5 id="b）server-xml"><a href="#b）server-xml" class="headerlink" title="b）server.xml"></a>b）server.xml</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">user</span> <span class="attr">name</span>=<span class="string">&quot;root&quot;</span> <span class="attr">defaultAccount</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span>&gt;</span> 123456 <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;schemas&quot;</span>&gt;</span>SHOPPING,ITCAST,ITCAST_RW<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 表级 DML 权限设置 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--</span></span><br><span class="line"><span class="comment">    &lt;privileges check=&quot;true&quot;&gt;</span></span><br><span class="line"><span class="comment">    &lt;schema name=&quot;DB01&quot; dml=&quot;0110&quot; &gt;</span></span><br><span class="line"><span class="comment">    &lt;table name=&quot;TB_ORDER&quot; dml=&quot;1110&quot;&gt;&lt;/table&gt;</span></span><br><span class="line"><span class="comment">    &lt;/schema&gt;</span></span><br><span class="line"><span class="comment">    &lt;/privileges&gt;</span></span><br><span class="line"><span class="comment">    --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">user</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>主要就是保证用户能操作配置的schema</li>
</ul>
<h4 id="④问题"><a href="#④问题" class="headerlink" title="④问题"></a>④问题</h4><ul>
<li>现在确实做到了读写分离，但是当主节点宕机后，虽然还可以进行读操作，但是不能执行写操作了<ul>
<li>为了解决该问题，我们考虑<strong>双主双从模式</strong></li>
</ul>
</li>
</ul>
<img src="https://s2.loli.net/2022/07/21/1dPCQFeINMu8wrp.png" alt="image-20220721155637241" style="zoom:80%;" />



<h3 id="3）双主双从"><a href="#3）双主双从" class="headerlink" title="3）双主双从"></a>3）双主双从</h3><h4 id="①结构"><a href="#①结构" class="headerlink" title="①结构"></a>①结构</h4><img src="https://s2.loli.net/2022/07/21/fzG1PNBgWQKO4cZ.png" alt="image-20220721161228146" style="zoom: 67%;" />

<p>一个主机 Master1 用于处理所有写请求，它的从机 Slave1 和另一台主机 Master2 还有它的从机 Slave2 负责所有读请求。当 Master1 主机宕机后，Master2 主机负责写请求，Master1 、Master2 互为备机。</p>
<ul>
<li>所有读请求都交给m1处理，m2,s1,s2处理读请求</li>
</ul>
<table>
<thead>
<tr>
<th>编号</th>
<th>IP</th>
<th>预装软件</th>
<th>角色</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>192.168.200.210</td>
<td>MyCat、MySQL</td>
<td>MyCat中间件服务器</td>
</tr>
<tr>
<td>2</td>
<td>192.168.200.211</td>
<td>MySQL</td>
<td>M1</td>
</tr>
<tr>
<td>3</td>
<td>192.168.200.212</td>
<td>MySQL</td>
<td>S1</td>
</tr>
<tr>
<td>4</td>
<td>192.168.200.213</td>
<td>MySQL</td>
<td>M2</td>
</tr>
<tr>
<td>5</td>
<td>192.168.200.214</td>
<td>MySQL</td>
<td>S2</td>
</tr>
</tbody></table>
<h4 id="②搭建双主双从结构"><a href="#②搭建双主双从结构" class="headerlink" title="②搭建双主双从结构"></a>②搭建双主双从结构</h4><h5 id="a）M1"><a href="#a）M1" class="headerlink" title="a）M1"></a>a）M1</h5><ol>
<li>修改Mysql配置文件 &#x2F;etc&#x2F;my.cnf</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql 服务ID，保证整个集群环境中唯一，取值范围：1 – 2^32-1，默认为 1</span></span><br><span class="line"><span class="attr">server-id</span>= <span class="string">1</span></span><br><span class="line"><span class="comment">#指定同步的数据库</span></span><br><span class="line"><span class="attr">binlog-do-db</span>=<span class="string">db01</span></span><br><span class="line"><span class="attr">binlog-do-db</span>=<span class="string">db02</span></span><br><span class="line"><span class="attr">binlog-do-db</span>=<span class="string">db03</span></span><br><span class="line"><span class="comment"># 在作为从数据库的时候，有写入操作也要更新二进制日志文件</span></span><br><span class="line"><span class="attr">log-slave-updates</span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置mysql实例的id，保证整个集群环境中唯一，这里是1</li>
<li>指定要同步的数据库，其它的数据库不同步</li>
</ul>
<ol start="2">
<li>重启MySQL服务器</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>创建账户并授权</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建itcast用户，并设置密码，该用户可在任意主机连接该MySQL服务</span></span><br><span class="line">CREATE USER <span class="string">&#x27;itcast&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;Root@123456&#x27;</span>;</span><br><span class="line"><span class="comment"># 为 &#x27;itcast&#x27;@&#x27;%&#x27; 用户分配主从复制权限</span></span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO <span class="string">&#x27;itcast&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建用于进行主从同步的账户并授予主从复制权限</li>
</ul>
<ol start="4">
<li>通过指令，查看两台主库的二进制日志坐标</li>
</ol>
<p><img src="https://s2.loli.net/2022/07/21/HNPqpw5ZlACn3Y7.png" alt="image-20220721162027791"></p>
<ul>
<li>看记录到了哪一个binlog，在该binlog的哪个位置开始</li>
</ul>
<h5 id="b）M2"><a href="#b）M2" class="headerlink" title="b）M2"></a>b）M2</h5><ol>
<li>修改Mysql配置文件 &#x2F;etc&#x2F;my.cnf</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mysql 服务ID，保证整个集群环境中唯一，取值范围：1 – 2^32-1，默认为 1</span></span><br><span class="line"><span class="attr">server-id</span>= <span class="string">3</span></span><br><span class="line"><span class="comment"># 指定同步的数据库</span></span><br><span class="line"><span class="attr">binlog-do-db</span>=<span class="string">db01</span></span><br><span class="line"><span class="attr">binlog-do-db</span>=<span class="string">db02</span></span><br><span class="line"><span class="attr">binlog-do-db</span>=<span class="string">db03</span></span><br><span class="line"><span class="comment"># 在作为从数据库的时候，有写入操作也要更新二进制日志文件</span></span><br><span class="line"><span class="attr">log-slave-updates</span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置mysql实例的id，保证整个集群环境中唯一，这里是3</li>
<li>指定要同步的数据库，其它的数据库不同步</li>
</ul>
<ol start="2">
<li>重启MySQL服务器</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>



<ol start="3">
<li>创建账户并授权</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建itcast用户，并设置密码，该用户可在任意主机连接该MySQL服务</span></span><br><span class="line">CREATE USER <span class="string">&#x27;itcast&#x27;</span>@<span class="string">&#x27;%&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="string">&#x27;Root@123456&#x27;</span>;</span><br><span class="line"><span class="comment">#为 &#x27;itcast&#x27;@&#x27;%&#x27; 用户分配主从复制权限</span></span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO <span class="string">&#x27;itcast&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>创建用于进行主从同步的账户并授予主从复制权限</li>
</ul>
<ol start="4">
<li>通过指令，查看两台主库的二进制日志坐标</li>
</ol>
<h5 id="c）S1"><a href="#c）S1" class="headerlink" title="c）S1"></a>c）S1</h5><ol>
<li>修改配置文件 &#x2F;etc&#x2F;my.cnf</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql 服务ID，保证整个集群环境中唯一，取值范围：1 – 232-1，默认为 1</span></span><br><span class="line"><span class="attr">server-id</span>= <span class="string">2</span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置mysql实例的id，保证整个集群环境中唯一，这里是2</li>
<li>这里不需要配置要同步的数据库，因为S1没有从库要同步自己的数据</li>
</ul>
<ol start="2">
<li>重新启动MySQL服务器</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>



<h5 id="d）S2"><a href="#d）S2" class="headerlink" title="d）S2"></a>d）S2</h5><ol>
<li>修改配置文件 &#x2F;etc&#x2F;my.cnf</li>
</ol>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#mysql 服务ID，保证整个集群环境中唯一，取值范围：1 – 232-1，默认为 1</span></span><br><span class="line"><span class="attr">server-id</span>= <span class="string">4</span></span><br></pre></td></tr></table></figure>

<ul>
<li>配置mysql实例的id，保证整个集群环境中唯一，这里是4</li>
<li>这里不需要配置要同步的数据库，因为S2没有从库要同步自己的数据</li>
</ul>
<ol start="2">
<li>重新启动MySQL服务器</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure>



<h5 id="e）S1同步M1，S2同步M2"><a href="#e）S1同步M1，S2同步M2" class="headerlink" title="e）S1同步M1，S2同步M2"></a>e）S1同步M1，S2同步M2</h5><img src="https://s2.loli.net/2022/07/21/noOqhs3VC8idgWF.png" alt="image-20220721163323606" style="zoom:50%;" />

<ol>
<li>在 slave1(192.168.200.212)上执行</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;192.168.200.211&#x27;</span>, MASTER_USER=<span class="string">&#x27;itcast&#x27;</span>,</span><br><span class="line">MASTER_PASSWORD=<span class="string">&#x27;Root@123456&#x27;</span>, MASTER_LOG_FILE=<span class="string">&#x27;binlog.000002&#x27;</span>,</span><br><span class="line">MASTER_LOG_POS= 663 ;</span><br></pre></td></tr></table></figure>

<ul>
<li>指定了M1的ip，使用的用户信息，开始同步的位置</li>
</ul>
<ol start="2">
<li>在 slave2(192.168.200.214)上执行</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;192.168.200.213&#x27;</span>, MASTER_USER=<span class="string">&#x27;itcast&#x27;</span>,</span><br><span class="line">MASTER_PASSWORD=<span class="string">&#x27;Root@123456&#x27;</span>, MASTER_LOG_FILE=<span class="string">&#x27;binlog.000002&#x27;</span>,</span><br><span class="line">MASTER_LOG_POS= 663 ;</span><br></pre></td></tr></table></figure>

<ul>
<li>指定了M2的ip，使用的用户信息，开始同步的位置</li>
</ul>
<ol start="3">
<li>启动两台从库主从复制，查看从库状态</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start slave;</span><br><span class="line">show slave status \G;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/07/21/trzvu2KpgwRV91q.png" alt="image-20220721163148674"></p>
<h5 id="f）M1和M2相互同步"><a href="#f）M1和M2相互同步" class="headerlink" title="f）M1和M2相互同步"></a>f）M1和M2相互同步</h5><img src="https://s2.loli.net/2022/07/21/8PiBRArmn6DJXHy.png" alt="image-20220721163259539" style="zoom:50%;" />

<ol>
<li>在 Master1(192.168.200.211)上执行</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;192.168.200.213&#x27;</span>, MASTER_USER=<span class="string">&#x27;itcast&#x27;</span>,</span><br><span class="line">MASTER_PASSWORD=<span class="string">&#x27;Root@123456&#x27;</span>, MASTER_LOG_FILE=<span class="string">&#x27;binlog.000002&#x27;</span>,</span><br><span class="line">MASTER_LOG_POS= 663 ;</span><br></pre></td></tr></table></figure>

<ul>
<li>指定了M2的ip，使用的用户信息，开始同步的位置</li>
</ul>
<ol start="2">
<li>在 Master2(192.168.200.213)上执行</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO MASTER_HOST=<span class="string">&#x27;192.168.200.211&#x27;</span>, MASTER_USER=<span class="string">&#x27;itcast&#x27;</span>,</span><br><span class="line">MASTER_PASSWORD=<span class="string">&#x27;Root@123456&#x27;</span>, MASTER_LOG_FILE=<span class="string">&#x27;binlog.000002&#x27;</span>,</span><br><span class="line">MASTER_LOG_POS= 663 ;</span><br></pre></td></tr></table></figure>

<ul>
<li>指定了M1的ip，使用的用户信息，开始同步的位置</li>
</ul>
<ol start="3">
<li>启动两台从库主从复制，查看从库状态</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start slave;</span><br><span class="line">show slave status \G;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/07/21/aQ3duPGOAqNBKYD.png" alt="image-20220721163513639"></p>
<h4 id="③Mycat-配置读写分离-1"><a href="#③Mycat-配置读写分离-1" class="headerlink" title="③Mycat 配置读写分离"></a>③Mycat 配置读写分离</h4><p><img src="https://s2.loli.net/2022/07/21/QyqFYMouOxelrnZ.png" alt="image-20220721165626935"></p>
<ul>
<li>dataHost中配置了主从关系</li>
<li>以下是dataHost标签详解</li>
</ul>
<p><img src="https://s2.loli.net/2022/07/21/1ErpR5x4LhSmtBC.png" alt="image-20220721165823871"></p>
<ul>
<li>当配置好了以后，如果M1宕机了，还是可以进行写操作，M2会负责</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/mysql/" rel="tag"># mysql</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/04/04/mysql%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/" rel="prev" title="mysql基本语法">
      <i class="fa fa-chevron-left"></i> mysql基本语法
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/04/10/rabbitMQ%20-%20%E5%89%AF%E6%9C%AC/" rel="next" title="rabbitMQ">
      rabbitMQ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E4%BA%8B%E5%8A%A1"><span class="nav-text">一、事务</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%9B%9B%E5%A4%A7%E7%89%B9%E6%80%A7ACID"><span class="nav-text">1.四大特性ACID</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%B9%B6%E5%8F%91%E4%BA%8B%E5%8A%A1"><span class="nav-text">2.并发事务</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E"><span class="nav-text">二、存储引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-MySQL%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="nav-text">1. MySQL体系结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%B8%B8%E8%A7%81%E5%BC%95%E6%93%8E"><span class="nav-text">2. 常见引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89InnoDB"><span class="nav-text">1）InnoDB</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89MyISAM"><span class="nav-text">2）MyISAM</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89Memory"><span class="nav-text">3）Memory</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%89%B9%E7%82%B9%E6%AF%94%E8%BE%83"><span class="nav-text">3. 存储引擎特点比较</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E7%9A%84%E9%80%89%E6%8B%A9"><span class="nav-text">4. 存储引擎的选择</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%89%E3%80%81-%E7%B4%A2%E5%BC%95"><span class="nav-text">三、 索引</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84"><span class="nav-text">1. 索引结构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E4%BA%8C%E5%8F%89%E6%90%9C%E7%B4%A2%E6%A0%91"><span class="nav-text">1）二叉搜索树</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89B-Tree"><span class="nav-text">2）B Tree</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89B-Tree"><span class="nav-text">3）B+Tree</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%EF%BC%89InooDB%E7%9A%84%E6%94%B9%E8%BF%9BB-Tree"><span class="nav-text">4）InooDB的改进B+ Tree</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%EF%BC%89Hash%E7%B4%A2%E5%BC%95"><span class="nav-text">5）Hash索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6%EF%BC%89%E9%9D%A2%E8%AF%95%E9%A2%98"><span class="nav-text">6）面试题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E7%B4%A2%E5%BC%95%E5%88%86%E7%B1%BB"><span class="nav-text">2. 索引分类</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="nav-text">1）基本结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E6%80%9D%E8%80%83%E9%A2%98"><span class="nav-text">2）思考题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E7%B4%A2%E5%BC%95%E8%AF%AD%E6%B3%95"><span class="nav-text">3. 索引语法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-sql%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90"><span class="nav-text">4. sql性能分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E6%9F%A5%E7%9C%8B%E6%89%A7%E8%A1%8C%E9%A2%91%E6%AC%A1"><span class="nav-text">1）查看执行频次</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="nav-text">2）慢查询日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89profile"><span class="nav-text">3）profile</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%EF%BC%89explain"><span class="nav-text">4）explain</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E4%BD%BF%E7%94%A8%E8%A7%84%E5%88%99"><span class="nav-text">5. 使用规则</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E6%9C%80%E5%B7%A6%E5%89%8D%E7%BC%80%E6%B3%95%E5%88%99%EF%BC%88%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95%EF%BC%89"><span class="nav-text">1）最左前缀法则（联合索引）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E6%99%AE%E9%80%9A%E7%B4%A2%E5%BC%95%E5%A4%B1%E6%95%88%E6%83%85%E5%86%B5"><span class="nav-text">2）普通索引失效情况</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89SQL-%E6%8F%90%E7%A4%BA"><span class="nav-text">3）SQL 提示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%EF%BC%89%E8%A6%86%E7%9B%96%E7%B4%A2%E5%BC%95-amp-%E5%9B%9E%E8%A1%A8%E6%9F%A5%E8%AF%A2"><span class="nav-text">4）覆盖索引&amp;回表查询</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%EF%BC%89%E5%89%8D%E7%BC%80%E7%B4%A2%E5%BC%95"><span class="nav-text">5）前缀索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6%EF%BC%89%E5%8D%95%E5%88%97%E7%B4%A2%E5%BC%95-amp-%E8%81%94%E5%90%88%E7%B4%A2%E5%BC%95"><span class="nav-text">6）单列索引&amp;联合索引</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7%EF%BC%89%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="nav-text">7）设计原则</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%9B%9B%E3%80%81-sql%E4%BC%98%E5%8C%96"><span class="nav-text">四、 sql优化</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%8F%92%E5%85%A5%E6%95%B0%E6%8D%AE%EF%BC%88insert%EF%BC%8Cload%EF%BC%89"><span class="nav-text">1.插入数据（insert，load）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E9%A1%B5%E5%88%86%E8%A3%82%E5%92%8C%E9%A1%B5%E5%90%88%E5%B9%B6"><span class="nav-text">2.页分裂和页合并</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0%E9%A1%B5%E5%88%86%E8%A3%82"><span class="nav-text">①页分裂</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1%E9%A1%B5%E5%90%88%E5%B9%B6"><span class="nav-text">②页合并</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-order-by%E4%BC%98%E5%8C%96"><span class="nav-text">3.order by优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-group-by%E4%BC%98%E5%8C%96"><span class="nav-text">4.group by优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-limit%E4%BC%98%E5%8C%96"><span class="nav-text">5.limit优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-count%E4%BC%98%E5%8C%96"><span class="nav-text">6.count优化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-update%E4%BC%98%E5%8C%96%EF%BC%88%E9%81%BF%E5%85%8D%E8%A1%8C%E9%94%81%E5%8D%87%E7%BA%A7%E4%B8%BA%E8%A1%A8%E9%94%81%EF%BC%89"><span class="nav-text">7.update优化（避免行锁升级为表锁）</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BA%94%E3%80%81%E8%A7%86%E5%9B%BE-x2F-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B-x2F-%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-text">五、视图&#x2F;存储过程&#x2F;触发器</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E8%A7%86%E5%9B%BE"><span class="nav-text">1. 视图</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-text">2. 存储过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E5%8F%98%E9%87%8F"><span class="nav-text">1）变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E4%B8%AD%E7%9A%84%E8%AF%AD%E6%B3%95"><span class="nav-text">2）存储过程中的语法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0if"><span class="nav-text">①if</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1case"><span class="nav-text">②case</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A2while"><span class="nav-text">③while</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A3repeat"><span class="nav-text">④repeat</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A4loop"><span class="nav-text">⑤loop</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A5cursor-%E6%B8%B8%E6%A0%87"><span class="nav-text">⑥cursor 游标</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A6handler-%E6%9D%A1%E4%BB%B6%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"><span class="nav-text">⑦handler 条件处理程序</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0"><span class="nav-text">3）存储函数</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%A7%A6%E5%8F%91%E5%99%A8"><span class="nav-text">3. 触发器</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AD%E3%80%81%E9%94%81"><span class="nav-text">六、锁</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%85%A8%E5%B1%80%E9%94%81"><span class="nav-text">1. 全局锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">1）基本概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0%E5%A4%87%E4%BB%BD%E4%B8%8D%E5%8A%A0%E9%94%81"><span class="nav-text">①备份不加锁</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1%E5%A4%87%E4%BB%BD%E5%8A%A0%E9%94%81"><span class="nav-text">②备份加锁</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E4%BD%BF%E7%94%A8"><span class="nav-text">2）使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89%E7%89%B9%E7%82%B9"><span class="nav-text">3）特点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E8%A1%A8%E7%BA%A7%E9%94%81"><span class="nav-text">2. 表级锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E8%A1%A8%E9%94%81"><span class="nav-text">1）表锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E5%85%83%E6%95%B0%E6%8D%AE%E9%94%81"><span class="nav-text">2）元数据锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89%E6%84%8F%E5%90%91%E9%94%81"><span class="nav-text">3）意向锁</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E8%A1%8C%E7%BA%A7%E9%94%81"><span class="nav-text">3. 行级锁</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E8%A1%8C%E9%94%81"><span class="nav-text">1）行锁</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E9%97%B4%E9%9A%99%E9%94%81%E3%80%81%E4%B8%B4%E9%94%AE%E9%94%81"><span class="nav-text">2）间隙锁、临键锁</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0%E5%A6%82%E5%BD%93%E4%BA%8B%E5%8A%A1A%E7%94%A8%E4%B8%BB%E9%94%AE%E6%90%9C%E5%AF%BB%E4%B8%8D%E5%AD%98%E5%9C%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E7%9A%84%E6%97%B6%E5%80%99%EF%BC%9A"><span class="nav-text">①如当事务A用主键搜寻不存在的数据的时候：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1%E5%9B%A0%E4%B8%BA%E6%98%AF%E9%9D%9E%E5%94%AF%E4%B8%80%E7%B4%A2%E5%BC%95%EF%BC%8C%E6%89%80%E4%BB%A5%E4%BC%9A%E5%87%BA%E7%8E%B0%E9%87%8D%E5%A4%8D%E5%80%BC"><span class="nav-text">②因为是非唯一索引，所以会出现重复值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A2%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2%E9%94%81%E5%88%B0%E4%B8%8D%E6%BB%A1%E8%B6%B3%E8%A6%81%E6%B1%82%E4%B8%BA%E6%AD%A2"><span class="nav-text">③范围查询锁到不满足要求为止</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%83%E3%80%81InnoDB%E5%BC%95%E6%93%8E"><span class="nav-text">七、InnoDB引擎</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%9E%B6%E6%9E%84%E5%9B%BE"><span class="nav-text">1. 架构图</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E9%80%BB%E8%BE%91%E7%BB%93%E6%9E%84"><span class="nav-text">1）逻辑结构</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E7%89%A9%E7%90%86%E7%BB%93%E6%9E%84"><span class="nav-text">2）物理结构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%BA%8B%E5%8A%A1%E5%8E%9F%E7%90%86"><span class="nav-text">2. 事务原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89redo-log"><span class="nav-text">1）redo log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89undo-log"><span class="nav-text">2）undo log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89MVCC"><span class="nav-text">3）MVCC</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0%E5%BD%93%E5%89%8D%E8%AF%BB%E5%92%8C%E5%BF%AB%E7%85%A7%E8%AF%BB"><span class="nav-text">①当前读和快照读</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89%E5%BD%93%E5%89%8D%E8%AF%BB"><span class="nav-text">a）当前读</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89%E5%BF%AB%E7%85%A7%E8%AF%BB"><span class="nav-text">b）快照读</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1%E9%9A%90%E8%97%8F%E5%AD%97%E6%AE%B5"><span class="nav-text">②隐藏字段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A2undo-log"><span class="nav-text">③undo log</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A3readview-%E8%AF%BB%E8%A7%86%E5%9B%BE%EF%BC%89"><span class="nav-text">④readview(读视图）</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89%E5%AD%97%E6%AE%B5"><span class="nav-text">a）字段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89%E5%AE%9A%E4%B9%89%E7%9A%84%E8%AE%BF%E9%97%AEundo-log-%E7%89%88%E6%9C%AC%E9%93%BE%E7%9A%84%E8%A7%84%E5%88%99"><span class="nav-text">b）定义的访问undo log 版本链的规则</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A4RC%E5%92%8CRR%E7%9A%84MVCC"><span class="nav-text">⑤RC和RR的MVCC</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89RC-%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-text">a）RC 隔离级别</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89RR-%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="nav-text">b）RR 隔离级别</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%85%AB%E3%80%81%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="nav-text">八、高可用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E6%97%A5%E5%BF%97"><span class="nav-text">1.日志</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="nav-text">1）错误日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%97%A5%E5%BF%97"><span class="nav-text">2）二进制日志</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="nav-text">①基本概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1binlog%E6%A0%BC%E5%BC%8F"><span class="nav-text">②binlog格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A2binlog%E7%9A%84%E6%9F%A5%E7%9C%8B"><span class="nav-text">③binlog的查看</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A3binlog%E7%9A%84%E5%88%A0%E9%99%A4"><span class="nav-text">④binlog的删除</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="nav-text">3）查询日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%EF%BC%89%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="nav-text">4）慢查询日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-text">2.主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-1"><span class="nav-text">1）基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E5%8E%9F%E7%90%86"><span class="nav-text">2）原理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89%E6%90%AD%E5%BB%BA"><span class="nav-text">3）搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0%E5%9F%BA%E6%9C%AC%E7%BB%84%E6%88%90"><span class="nav-text">①基本组成</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1%E4%B8%BB%E5%BA%93"><span class="nav-text">②主库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1%E4%BB%8E%E5%BA%93"><span class="nav-text">②从库</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%88%86%E5%BA%93%E5%88%86%E8%A1%A8"><span class="nav-text">3.分库分表</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-2"><span class="nav-text">1）基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5"><span class="nav-text">2）分片策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-1"><span class="nav-text">①基本概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1%E5%9E%82%E7%9B%B4%E5%88%86%E5%BA%93"><span class="nav-text">②垂直分库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A2%E5%9E%82%E7%9B%B4%E5%88%86%E8%A1%A8"><span class="nav-text">③垂直分表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A3%E6%B0%B4%E5%B9%B3%E5%88%86%E5%BA%93"><span class="nav-text">④水平分库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A4%E6%B0%B4%E5%B9%B3%E5%88%86%E8%A1%A8"><span class="nav-text">⑤水平分表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A5%E5%AE%9E%E7%8E%B0%E6%8A%80%E6%9C%AF"><span class="nav-text">⑥实现技术</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89Mycat%E7%9A%84%E6%A6%82%E8%BF%B0"><span class="nav-text">3）Mycat的概述</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-2"><span class="nav-text">①基本概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="nav-text">②目录结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A2%E5%9F%BA%E6%9C%AC%E7%BB%93%E6%9E%84"><span class="nav-text">③基本结构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4%EF%BC%89Mycat-example"><span class="nav-text">4）Mycat example</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0%E9%9C%80%E6%B1%82"><span class="nav-text">①需求</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="nav-text">②环境准备</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A2%E9%85%8D%E7%BD%AE"><span class="nav-text">③配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A3%E4%BD%BF%E7%94%A8"><span class="nav-text">④使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5%EF%BC%89Mycat-%E9%85%8D%E7%BD%AE"><span class="nav-text">5）Mycat 配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0schema-xml"><span class="nav-text">①schema.xml</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89schema-%E6%A0%87%E7%AD%BE"><span class="nav-text">a）schema 标签</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89datanode%E6%A0%87%E7%AD%BE"><span class="nav-text">b）datanode标签</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#c%EF%BC%89datahost%E6%A0%87%E7%AD%BE"><span class="nav-text">c）datahost标签</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1rule-xml"><span class="nav-text">②rule.xml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A2server-xml"><span class="nav-text">③server.xml</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89system%E6%A0%87%E7%AD%BE"><span class="nav-text">a）system标签</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89user%E6%A0%87%E7%AD%BE"><span class="nav-text">b）user标签</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#6%EF%BC%89Mycat-%E5%88%86%E7%89%87"><span class="nav-text">6）Mycat 分片</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0%E5%9E%82%E7%9B%B4%E6%8B%86%E5%88%86"><span class="nav-text">①垂直拆分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89%E5%9C%BA%E6%99%AF"><span class="nav-text">a）场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89%E9%85%8D%E7%BD%AE"><span class="nav-text">b）配置</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#c%EF%BC%89%E6%B5%8B%E8%AF%95"><span class="nav-text">c）测试</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#d%EF%BC%89%E5%85%A8%E5%B1%80%E8%A1%A8"><span class="nav-text">d）全局表</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1%E6%B0%B4%E5%B9%B3%E6%8B%86%E5%88%86"><span class="nav-text">②水平拆分</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89%E5%9C%BA%E6%99%AF-1"><span class="nav-text">a）场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89%E9%85%8D%E7%BD%AE-1"><span class="nav-text">b）配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7%EF%BC%89Mycat-%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5"><span class="nav-text">7）Mycat 分片策略</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0%E8%8C%83%E5%9B%B4%E5%88%86%E7%89%87"><span class="nav-text">①范围分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89%E5%9C%BA%E6%99%AF-2"><span class="nav-text">a）场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89%E9%85%8D%E7%BD%AE-2"><span class="nav-text">b）配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1%E5%8F%96%E6%A8%A1%E5%88%86%E7%89%87"><span class="nav-text">②取模分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89%E5%9C%BA%E6%99%AF-3"><span class="nav-text">a）场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89%E9%85%8D%E7%BD%AE-3"><span class="nav-text">b）配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A2%E4%B8%80%E8%87%B4%E6%80%A7hash%E5%88%86%E7%89%87"><span class="nav-text">③一致性hash分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89%E5%9C%BA%E6%99%AF-4"><span class="nav-text">a）场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89%E9%85%8D%E7%BD%AE-4"><span class="nav-text">b）配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A3%E6%9E%9A%E4%B8%BE%E5%88%86%E7%89%87"><span class="nav-text">④枚举分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89%E5%9C%BA%E6%99%AF-5"><span class="nav-text">a）场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89%E9%85%8D%E7%BD%AE-5"><span class="nav-text">b）配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A4%E5%BA%94%E7%94%A8%E6%8C%87%E5%AE%9A%E7%AE%97%E6%B3%95"><span class="nav-text">⑤应用指定算法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89%E5%9C%BA%E6%99%AF-6"><span class="nav-text">a）场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89%E9%85%8D%E7%BD%AE-6"><span class="nav-text">b）配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A5%E5%9B%BA%E5%AE%9Ahash%E7%AE%97%E6%B3%95"><span class="nav-text">⑥固定hash算法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89%E5%9C%BA%E6%99%AF-7"><span class="nav-text">a）场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89%E9%85%8D%E7%BD%AE-7"><span class="nav-text">b）配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A6%E5%AD%97%E7%AC%A6%E4%B8%B2hash%E8%A7%A3%E6%9E%90"><span class="nav-text">⑦字符串hash解析</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89%E5%9C%BA%E6%99%AF-8"><span class="nav-text">a）场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89%E9%85%8D%E7%BD%AE-8"><span class="nav-text">b）配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A7%E6%8C%89%E5%A4%A9%E5%88%86%E7%89%87"><span class="nav-text">⑧按天分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89%E5%9C%BA%E6%99%AF-9"><span class="nav-text">a）场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89%E9%85%8D%E7%BD%AE-9"><span class="nav-text">b）配置</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A8%E6%8C%89%E8%87%AA%E7%84%B6%E6%9C%88%E5%88%86%E7%89%87"><span class="nav-text">⑨按自然月分片</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89%E5%9C%BA%E6%99%AF-10"><span class="nav-text">a）场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89%E9%85%8D%E7%BD%AE-10"><span class="nav-text">b）配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#8%EF%BC%89Mycat-%E7%AE%A1%E7%90%86%E5%92%8C%E7%9B%91%E6%8E%A7"><span class="nav-text">8）Mycat 管理和监控</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86"><span class="nav-text">①基本原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1Mycat-%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7"><span class="nav-text">②Mycat 管理工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A2Mycat-%E7%9B%91%E6%8E%A7"><span class="nav-text">③Mycat 监控</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="nav-text">4.读写分离</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1%EF%BC%89%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5-3"><span class="nav-text">1）基本概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2%EF%BC%89%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E"><span class="nav-text">2）一主一从</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0%E5%8E%9F%E7%90%86"><span class="nav-text">①原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1%E6%90%AD%E5%BB%BA%E4%B8%80%E4%B8%BB%E4%B8%80%E4%BB%8E%E7%BB%93%E6%9E%84"><span class="nav-text">②搭建一主一从结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A2Mycat-%E9%85%8D%E7%BD%AE%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB"><span class="nav-text">③Mycat 配置读写分离</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89scheam-xml"><span class="nav-text">a）scheam.xml</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89server-xml"><span class="nav-text">b）server.xml</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A3%E9%97%AE%E9%A2%98"><span class="nav-text">④问题</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3%EF%BC%89%E5%8F%8C%E4%B8%BB%E5%8F%8C%E4%BB%8E"><span class="nav-text">3）双主双从</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A0%E7%BB%93%E6%9E%84"><span class="nav-text">①结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A1%E6%90%AD%E5%BB%BA%E5%8F%8C%E4%B8%BB%E5%8F%8C%E4%BB%8E%E7%BB%93%E6%9E%84"><span class="nav-text">②搭建双主双从结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#a%EF%BC%89M1"><span class="nav-text">a）M1</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#b%EF%BC%89M2"><span class="nav-text">b）M2</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#c%EF%BC%89S1"><span class="nav-text">c）S1</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#d%EF%BC%89S2"><span class="nav-text">d）S2</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#e%EF%BC%89S1%E5%90%8C%E6%AD%A5M1%EF%BC%8CS2%E5%90%8C%E6%AD%A5M2"><span class="nav-text">e）S1同步M1，S2同步M2</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#f%EF%BC%89M1%E5%92%8CM2%E7%9B%B8%E4%BA%92%E5%90%8C%E6%AD%A5"><span class="nav-text">f）M1和M2相互同步</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E2%91%A2Mycat-%E9%85%8D%E7%BD%AE%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB-1"><span class="nav-text">③Mycat 配置读写分离</span></a></li></ol></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="f1ashades"
      src="/images/mine.jpg">
  <p class="site-author-name" itemprop="name">f1ashades</p>
  <div class="site-description" itemprop="description">once again I am a child</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">20</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">f1ashades</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">707k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">10:43</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
